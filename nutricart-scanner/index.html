<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="theme-color" content="#0f172a" />
  <title>NutriCart Scanner</title>
  <link rel="manifest" href="#" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@700;800&family=DM+Sans:wght@300;400;500&display=swap');

    :root {
      --bg: #0a0f1e;
      --surface: #111827;
      --surface2: #1e2a3a;
      --accent: #22d3ee;
      --accent2: #a78bfa;
      --green: #4ade80;
      --red: #f87171;
      --yellow: #fbbf24;
      --text: #f1f5f9;
      --muted: #64748b;
      --border: #1e3a5f;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    #root {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      position: relative;
    }

    /* Header */
    .header {
      padding: 20px 16px 16px;
      background: linear-gradient(180deg, #0f1729 0%, transparent 100%);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(34, 211, 238, 0.1);
    }

    .header-top {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }

    .logo-text {
      font-family: 'Syne', sans-serif;
      font-size: 20px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .logo-sub {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-top: 1px;
    }

    /* Screen */
    .screen { padding: 16px; }

    /* Store selector */
    .section-label {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 10px;
    }

    .store-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 24px;
    }

    .store-btn {
      padding: 10px 6px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .store-btn.active {
      border-color: var(--accent);
      background: rgba(34, 211, 238, 0.08);
      color: var(--accent);
      font-weight: 500;
    }

    /* Scanner area */
    .scanner-box {
      position: relative;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 16px;
      aspect-ratio: 4/3;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scanner-box video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .scanner-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .scan-frame {
      width: 200px;
      height: 120px;
      position: relative;
    }

    .scan-frame::before, .scan-frame::after,
    .scan-frame-inner::before, .scan-frame-inner::after {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      border-color: var(--accent);
      border-style: solid;
    }

    .scan-frame::before { top: 0; left: 0; border-width: 2px 0 0 2px; border-radius: 4px 0 0 0; }
    .scan-frame::after { top: 0; right: 0; border-width: 2px 2px 0 0; border-radius: 0 4px 0 0; }
    .scan-frame-inner::before { bottom: 0; left: 0; border-width: 0 0 2px 2px; border-radius: 0 0 0 4px; }
    .scan-frame-inner::after { bottom: 0; right: 0; border-width: 0 2px 2px 0; border-radius: 0 0 4px 0; }

    .scan-line {
      position: absolute;
      left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      animation: scanLine 2s ease-in-out infinite;
      top: 0;
    }

    @keyframes scanLine {
      0% { top: 0%; opacity: 1; }
      50% { top: 100%; opacity: 0.5; }
      100% { top: 0%; opacity: 1; }
    }

    .scan-hint {
      margin-top: 16px;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: rgba(34, 211, 238, 0.7);
      letter-spacing: 1px;
    }

    .scanner-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 40px;
    }

    .scanner-icon {
      font-size: 48px;
      opacity: 0.4;
    }

    .scanner-start-text {
      font-size: 14px;
      color: var(--muted);
      text-align: center;
      line-height: 1.6;
    }

    /* Buttons */
    .btn-primary {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), #0891b2);
      color: #0a0f1e;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 15px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-secondary {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      background: transparent;
      color: var(--accent);
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      font-size: 14px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 10px;
    }

    /* Manual input */
    .manual-input-wrap {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .manual-input {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .manual-input:focus { border-color: var(--accent); }
    .manual-input::placeholder { color: var(--muted); }

    .manual-btn {
      padding: 12px 16px;
      border-radius: 12px;
      background: var(--accent);
      color: #0a0f1e;
      font-weight: 700;
      border: none;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
    }

    /* Result card */
    .result-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 16px;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-status {
      padding: 10px 16px;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .result-status.created { background: rgba(74, 222, 128, 0.1); color: var(--green); }
    .result-status.existing { background: rgba(167, 139, 250, 0.1); color: var(--accent2); }
    .result-status.error { background: rgba(248, 113, 113, 0.1); color: var(--red); }

    .result-body {
      padding: 16px;
    }

    .result-top {
      display: flex;
      gap: 12px;
      margin-bottom: 14px;
    }

    .product-img {
      width: 70px;
      height: 70px;
      border-radius: 12px;
      object-fit: contain;
      background: var(--surface2);
      flex-shrink: 0;
    }

    .product-img-placeholder {
      width: 70px;
      height: 70px;
      border-radius: 12px;
      background: var(--surface2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      flex-shrink: 0;
    }

    .product-info { flex: 1; min-width: 0; }

    .product-brand {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--accent);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .product-name {
      font-family: 'Syne', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
      line-height: 1.3;
    }

    .product-category {
      font-size: 12px;
      color: var(--muted);
    }

    .nutriscore {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 6px;
      font-family: 'Syne', sans-serif;
      font-size: 13px;
      font-weight: 800;
      margin-left: 8px;
    }

    .nutriscore-a { background: #1a7a1a; color: white; }
    .nutriscore-b { background: #5aaa15; color: white; }
    .nutriscore-c { background: #f0a500; color: white; }
    .nutriscore-d { background: #e6791f; color: white; }
    .nutriscore-e { background: #cc1212; color: white; }

    /* Macros */
    .macros-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 14px;
    }

    .macro-box {
      background: var(--surface2);
      border-radius: 10px;
      padding: 10px 6px;
      text-align: center;
    }

    .macro-val {
      font-family: 'DM Mono', monospace;
      font-size: 15px;
      font-weight: 500;
      color: var(--text);
    }

    .macro-lbl {
      font-size: 10px;
      color: var(--muted);
      margin-top: 3px;
    }

    .macro-kcal .macro-val { color: var(--accent); }

    /* Barcode display */
    .barcode-display {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      margin-top: 8px;
    }

    /* Divider */
    .divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 13px;
      z-index: 100;
      animation: fadeInOut 2.5s ease forwards;
      white-space: nowrap;
      backdrop-filter: blur(8px);
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      75% { opacity: 1; }
      100% { opacity: 0; transform: translateX(-50%) translateY(-5px); }
    }

    .loading-dots {
      display: flex;
      gap: 6px;
      justify-content: center;
      padding: 20px;
    }

    .loading-dots span {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: bounce 1.2s infinite;
    }

    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }
  
    /* ‚îÄ‚îÄ Menu g≈Ç√≥wne ‚îÄ‚îÄ */
    .menu-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 16px;
    }

    .menu-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 20px 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      text-align: left;
      min-height: 120px;
    }

    .menu-card:active { transform: scale(0.97); }

    .menu-card:hover {
      border-color: var(--accent);
      background: rgba(34, 211, 238, 0.04);
    }

    .menu-card-icon {
      font-size: 28px;
      line-height: 1;
    }

    .menu-card-title {
      font-family: 'Syne', sans-serif;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      line-height: 1.2;
    }

    .menu-card-sub {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }

    /* ‚îÄ‚îÄ Back button ‚îÄ‚îÄ */
    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      color: var(--muted);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      cursor: pointer;
      padding: 4px 0;
      margin-left: -2px;
    }

    /* ‚îÄ‚îÄ Product list ‚îÄ‚îÄ */
    .product-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(30, 58, 95, 0.5);
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .product-row:active { opacity: 0.7; }

    .product-row-img {
      width: 44px; height: 44px;
      border-radius: 10px;
      background: var(--surface2);
      object-fit: contain;
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px;
    }

    .product-row-info { flex: 1; min-width: 0; }

    .product-row-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-row-meta {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .status-badge {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      padding: 3px 7px;
      border-radius: 6px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .status-badge.active { background: rgba(74,222,128,0.12); color: var(--green); }
    .status-badge.inactive { background: rgba(248,113,113,0.12); color: var(--red); }
    .status-badge.deleted { background: rgba(100,116,139,0.15); color: var(--muted); }

    /* ‚îÄ‚îÄ Filter bar ‚îÄ‚îÄ */
    .filter-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
      overflow-x: auto;
      padding-bottom: 4px;
      scrollbar-width: none;
    }
    .filter-bar::-webkit-scrollbar { display: none; }

    .filter-chip {
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.15s;
      flex-shrink: 0;
    }

    .filter-chip.active {
      border-color: var(--accent);
      background: rgba(34,211,238,0.1);
      color: var(--accent);
    }

    /* ‚îÄ‚îÄ Saved barcodes ‚îÄ‚îÄ */
    .barcode-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .barcode-code {
      font-family: 'DM Mono', monospace;
      font-size: 14px;
      color: var(--accent);
    }

    .barcode-store {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .add-btn-sm {
      padding: 7px 14px;
      border-radius: 8px;
      background: rgba(34,211,238,0.1);
      border: 1px solid var(--accent);
      color: var(--accent);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ Search input ‚îÄ‚îÄ */
    .search-input {
      width: 100%;
      padding: 11px 14px;
      border-radius: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      outline: none;
      margin-bottom: 14px;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--accent); }
    .search-input::placeholder { color: var(--muted); }

    /* ‚îÄ‚îÄ Store row ‚îÄ‚îÄ */
    .store-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      margin-bottom: 10px;
    }

    .store-row-name {
      font-weight: 600;
      font-size: 15px;
    }

    /* Scan bulk counter */
    .bulk-counter {
      background: var(--surface2);
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      margin-bottom: 16px;
    }

    .bulk-count {
      font-family: 'Syne', sans-serif;
      font-size: 48px;
      font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }

    .bulk-label {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 2px;
      color: var(--muted);
      margin-top: 6px;
    }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel" data-presets="react">
const { useState, useEffect, useRef } = React;
const API = 'https://nutricart-production.up.railway.app/api';

// ‚îÄ‚îÄ Globals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function useStores() {
  const [stores, setStores] = useState([]);
  const reload = () => fetch(`${API}/stores?all=1`).then(r=>r.json()).then(setStores).catch(()=>{});
  useEffect(()=>{ reload(); }, []);
  return [stores, reload];
}

// ‚îÄ‚îÄ Ma≈Çe komponenty ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function NutriScore({ grade }) {
  if (!grade) return null;
  const g = grade.toUpperCase();
  return <span className={`nutriscore nutriscore-${g.toLowerCase()}`}>N{g}</span>;
}

function MacroBox({ val, lbl, className }) {
  return (
    <div className={`macro-box ${className||''}`}>
      <div className="macro-val">{val!=null ? Math.round(val) : '‚Äî'}</div>
      <div className="macro-lbl">{lbl}</div>
    </div>
  );
}

function Toast({ msg }) {
  if (!msg) return null;
  return <div className="toast">{msg}</div>;
}

function Dots() {
  return <div className="loading-dots"><span/><span/><span/></div>;
}

function BackBtn({ onBack, label = '‚Üê Wr√≥ƒá' }) {
  return (
    <button className="back-btn" onClick={onBack}>
      <span style={{fontSize:18}}>‚Üê</span> {label}
    </button>
  );
}

function StatusBadge({ status }) {
  const map = { active:'üü¢ aktywny', inactive_incomplete:'üî¥ niekompletny', inactive_deleted:'‚ö´ usuniƒôty', active_store:'üü¢', inactive:'üî¥', deleted:'‚ö´' };
  return <span className={`status-badge ${status?.includes('active') && !status.includes('in') ? 'active' : status?.includes('deleted') ? 'deleted' : 'inactive'}`}>{map[status] || status}</span>;
}

// ‚îÄ‚îÄ BarcodeScanner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function BarcodeScanner({ active, onDetected, continuous = false }) {
  const videoRef = useRef(null);
  const streamRef = useRef(null);
  const rafRef = useRef(null);
  const lastDetected = useRef('');

  useEffect(() => {
    if (active) startCamera(); else stopCamera();
    return () => stopCamera();
  }, [active]);

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } }
      });
      streamRef.current = stream;
      if (videoRef.current) { videoRef.current.srcObject = stream; videoRef.current.play(); }
      if ('BarcodeDetector' in window) {
        const detector = new BarcodeDetector({ formats: ['ean_13','ean_8','code_128','upc_a','upc_e','qr_code'] });
        const scan = async () => {
          if (!videoRef.current) return;
          if (videoRef.current.readyState === videoRef.current.HAVE_ENOUGH_DATA) {
            try {
              const barcodes = await detector.detect(videoRef.current);
              if (barcodes.length > 0) {
                const val = barcodes[0].rawValue;
                if (continuous) {
                  // w trybie bulk ‚Äî zapobiegaj duplikatom przez 2s
                  if (val !== lastDetected.current) {
                    lastDetected.current = val;
                    onDetected(val);
                    setTimeout(() => { lastDetected.current = ''; }, 2000);
                  }
                } else {
                  onDetected(val);
                  return;
                }
              }
            } catch(e) {}
          }
          rafRef.current = requestAnimationFrame(scan);
        };
        videoRef.current.addEventListener('loadeddata', () => { rafRef.current = requestAnimationFrame(scan); });
      }
    } catch(e) { console.error(e); }
  }

  function stopCamera() {
    if (rafRef.current) cancelAnimationFrame(rafRef.current);
    if (streamRef.current) { streamRef.current.getTracks().forEach(t=>t.stop()); streamRef.current = null; }
  }

  return (
    <div className="scanner-box" style={{background:'#000',position:'relative',overflow:'hidden',borderRadius:20,aspectRatio:'4/3',marginBottom:16}}>
      <video ref={videoRef} muted playsInline autoPlay
        style={{width:'100%',height:'100%',objectFit:'cover',display:active?'block':'none'}} />
      {active && (
        <div style={{position:'absolute',inset:0,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',pointerEvents:'none'}}>
          <div className="scan-frame"><div className="scan-frame-inner"/><div className="scan-line"/></div>
          <div className="scan-hint" style={{marginTop:12}}>SKIERUJ KAMERƒò NA KOD KRESKOWY</div>
        </div>
      )}
      {!active && (
        <div className="scanner-placeholder">
          <div className="scanner-icon">üì∑</div>
          <div className="scanner-start-text">Kliknij aby uruchomiƒá kamerƒô</div>
        </div>
      )}
    </div>
  );
}

// ‚îÄ‚îÄ ConfigScreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function ConfigScreen({ barcode, stores, onSaved, onBack }) {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState('');
  const [isNew, setIsNew] = useState(true);
  const [preview, setPreview] = useState(null);
  const [selectedStores, setSelectedStores] = useState([]);
  const [readyToEat, setReadyToEat] = useState(null);
  const [activate, setActivate] = useState(false);

  useEffect(() => { load(); }, [barcode]);

  async function load() {
    setLoading(true); setError('');
    try {
      const res = await fetch(`${API}/scan/${barcode}`);
      const data = await res.json();
      if (res.status === 404) { setError('Produkt nie znaleziony w OpenFoodFacts'); setLoading(false); return; }
      if (!res.ok) { setError(data.error || 'B≈ÇƒÖd'); setLoading(false); return; }
      setIsNew(data.is_new);
      setPreview(data.off_preview || data.product);
      if (data.is_new) {
        setSelectedStores([]); setReadyToEat(null); setActivate(false);
      } else {
        const p = data.product;
        setSelectedStores(p.store_ids || []);
        setReadyToEat(p.is_ready_to_eat === 1 ? true : p.is_ready_to_eat === 0 ? false : null);
        setActivate(p.status === 'active');
      }
    } catch(e) { setError('B≈ÇƒÖd po≈ÇƒÖczenia'); }
    finally { setLoading(false); }
  }

  function toggleStore(id) {
    setSelectedStores(prev => prev.includes(id) ? prev.filter(x=>x!==id) : [...prev, id]);
  }

  async function save() {
    setSaving(true); setError('');
    try {
      const body = { ...preview, store_ids: selectedStores,
        status: activate ? 'active' : 'inactive_incomplete',
        is_ready_to_eat: readyToEat === null ? null : (readyToEat ? 1 : 0) };
      const res = await fetch(`${API}/scan/${barcode}`, {
        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'B≈ÇƒÖd zapisu');
      onSaved(data.status, data.product);
    } catch(e) { setError(e.message); }
    finally { setSaving(false); }
  }

  if (loading) return <div style={{minHeight:'100vh',background:'var(--bg)',display:'flex',alignItems:'center',justifyContent:'center'}}><Dots/></div>;

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <div className="header">
        <div className="header-top">
          <button className="back-btn" onClick={onBack} style={{marginRight:8}}>‚Üê</button>
          <div className="logo-icon">{isNew?'‚ûï':'‚úèÔ∏è'}</div>
          <div>
            <div className="logo-text">NutriCart</div>
            <div className="logo-sub">{isNew?'Nowy produkt':'Edytuj produkt'}</div>
          </div>
        </div>
      </div>
      <div className="screen">
        {error && <div style={{background:'rgba(248,113,113,0.1)',border:'1px solid var(--red)',borderRadius:12,padding:12,marginBottom:16,color:'var(--red)',fontSize:13}}>{error}</div>}
        {preview && (
          <div className="result-card" style={{marginBottom:20}}>
            <div className={`result-status ${isNew?'created':'existing'}`}>{isNew?'üÜï Nowy produkt z OpenFoodFacts':'üì¶ Produkt ju≈º w bazie NutriCart'}</div>
            <div className="result-body">
              <div className="result-top">
                {preview.image_url ? <img className="product-img" src={preview.image_url} alt={preview.name}/> : <div className="product-img-placeholder">ü•´</div>}
                <div className="product-info">
                  {preview.brand && <div className="product-brand">{preview.brand}</div>}
                  <div className="product-name">{preview.name}<NutriScore grade={preview.nutriscore}/></div>
                  <div className="product-category">{preview.category||'inne'}{preview.quantity?` ¬∑ ${preview.quantity}`:''}</div>
                </div>
              </div>
              <div className="macros-grid">
                <MacroBox val={preview.calories_per_100g} lbl="kcal" className="macro-kcal"/>
                <MacroBox val={preview.protein_per_100g} lbl="bia≈Çko g"/>
                <MacroBox val={preview.carbs_per_100g} lbl="wƒôglowo."/>
                <MacroBox val={preview.fat_per_100g} lbl="t≈Çuszcze g"/>
              </div>
              <div className="barcode-display">BARCODE: {barcode}</div>
            </div>
          </div>
        )}

        <div className="section-label">Sklepy</div>
        <div className="store-grid" style={{marginBottom:24}}>
          {stores.filter(s=>s.status!=='deleted').map(s=>(
            <button key={s.id} className={`store-btn ${selectedStores.includes(s.id)?'active':''}`} onClick={()=>toggleStore(s.id)}>
              {selectedStores.includes(s.id)?'‚úì ':''}{s.name}
            </button>
          ))}
        </div>

        <div className="section-label">Gotowy do spo≈ºycia?</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:24}}>
          {[{val:true,label:'‚úÖ Tak',sub:'jogurt, jab≈Çko‚Ä¶'},{val:false,label:'üç≥ Nie',sub:'ry≈º, mƒÖka‚Ä¶'},{val:null,label:'‚ùì Nie wiem',sub:'p√≥≈∫niej'}].map(opt=>(
            <button key={String(opt.val)} onClick={()=>setReadyToEat(opt.val)}
              style={{padding:'12px 6px',borderRadius:12,border:'none',cursor:'pointer',
                background:readyToEat===opt.val?'rgba(34,211,238,0.12)':'var(--surface)',
                outline:readyToEat===opt.val?'2px solid var(--accent)':'1px solid var(--border)',
                color:readyToEat===opt.val?'var(--accent)':'var(--muted)',transition:'all 0.15s',textAlign:'center'}}>
              <div style={{fontSize:13,fontWeight:600}}>{opt.label}</div>
              <div style={{fontSize:10,marginTop:3,opacity:0.7}}>{opt.sub}</div>
            </button>
          ))}
        </div>

        <div className="section-label">Status</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:28}}>
          {[{val:true,label:'üü¢ Aktywny',sub:'widoczny w planach'},{val:false,label:'üî¥ Nieaktywny',sub:'wymaga uzupe≈Çnienia'}].map(opt=>(
            <button key={String(opt.val)} onClick={()=>setActivate(opt.val)}
              style={{padding:'12px 8px',borderRadius:12,border:'none',cursor:'pointer',
                background:activate===opt.val?'rgba(74,222,128,0.08)':'var(--surface)',
                outline:activate===opt.val?'2px solid var(--green)':'1px solid var(--border)',
                color:activate===opt.val?'var(--green)':'var(--muted)',transition:'all 0.15s',textAlign:'center'}}>
              <div style={{fontSize:13,fontWeight:600}}>{opt.label}</div>
              <div style={{fontSize:10,marginTop:3,opacity:0.7}}>{opt.sub}</div>
            </button>
          ))}
        </div>

        <button className="btn-primary" onClick={save} disabled={saving}>
          {saving?'Zapisujƒô...':(isNew?'üíæ Dodaj do bazy':'üíæ Zapisz zmiany')}
        </button>
        <button className="btn-secondary" onClick={onBack}>‚Üê Wr√≥ƒá bez zapisywania</button>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ SingleScanScreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function SingleScanScreen({ stores, onBack }) {
  const [scannerActive, setScannerActive] = useState(false);
  const [manualCode, setManualCode] = useState('');
  const [configBarcode, setConfigBarcode] = useState(null);
  const [toast, setToast] = useState('');

  function showToast(msg) { setToast(msg); setTimeout(()=>setToast(''), 2500); }

  function openConfig(bc) { setScannerActive(false); setConfigBarcode(bc); }

  if (configBarcode) return (
    <ConfigScreen barcode={configBarcode} stores={stores}
      onSaved={(s)=>{ setConfigBarcode(null); setManualCode(''); showToast(s==='created'?'‚úì Dodano!':'‚úì Zapisano!'); }}
      onBack={()=>setConfigBarcode(null)} />
  );

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Toast msg={toast}/>
      <div className="header">
        <div className="header-top">
          <button className="back-btn" onClick={onBack} style={{marginRight:8}}>‚Üê</button>
          <div className="logo-icon">üì∑</div>
          <div><div className="logo-text">NutriCart</div><div className="logo-sub">Skanowanie produktu</div></div>
        </div>
      </div>
      <div className="screen">
        <BarcodeScanner active={scannerActive} onDetected={openConfig}/>
        <button className="btn-primary" onClick={()=>setScannerActive(v=>!v)}>
          {scannerActive?'‚èπ Zatrzymaj skaner':'üì∑ Uruchom skaner'}
        </button>
        <div className="manual-input-wrap">
          <input className="manual-input" type="text" inputMode="numeric" placeholder="wpisz kod kreskowy..."
            value={manualCode} onChange={e=>setManualCode(e.target.value)}
            onKeyDown={e=>e.key==='Enter'&&manualCode.trim()&&openConfig(manualCode.trim())}/>
          <button className="manual-btn" disabled={!manualCode.trim()} onClick={()=>openConfig(manualCode.trim())}>‚Üí</button>
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ BulkScanScreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const SAVED_KEY = 'nutricart_saved_barcodes';

function BulkScanScreen({ stores, onBack }) {
  const [selectedStore, setSelectedStore] = useState(null);
  const [scannerActive, setScannerActive] = useState(false);
  const [scanned, setScanned] = useState([]); // { barcode, store_id, store_name, ts }
  const [toast, setToast] = useState('');

  function showToast(msg) { setToast(msg); setTimeout(()=>setToast(''),2000); }

  function handleDetected(bc) {
    if (!selectedStore) { showToast('‚ö† Wybierz sklep przed skanowaniem'); return; }
    setScanned(prev => {
      if (prev.some(x=>x.barcode===bc && x.store_id===selectedStore)) { showToast('Ju≈º zeskanowano'); return prev; }
      const storeName = stores.find(s=>s.id===selectedStore)?.name || '';
      const saved = [...prev, { barcode:bc, store_id:selectedStore, store_name:storeName, ts:Date.now() }];
      // Zapisz do localStorage (merguj z istniejƒÖcymi)
      const existing = JSON.parse(localStorage.getItem(SAVED_KEY)||'[]');
      const merged = [...existing.filter(x=>!(x.barcode===bc&&x.store_id===selectedStore)), { barcode:bc, store_id:selectedStore, store_name:storeName, ts:Date.now() }];
      localStorage.setItem(SAVED_KEY, JSON.stringify(merged));
      showToast(`‚úì ${bc}`);
      return saved;
    });
  }

  const activeStores = stores.filter(s=>s.status!=='deleted');

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Toast msg={toast}/>
      <div className="header">
        <div className="header-top">
          <button className="back-btn" onClick={onBack} style={{marginRight:8}}>‚Üê</button>
          <div className="logo-icon">üì¶</div>
          <div><div className="logo-text">NutriCart</div><div className="logo-sub">Skanowanie wielu</div></div>
        </div>
      </div>
      <div className="screen">
        <div className="section-label">Sklep</div>
        <div className="store-grid" style={{marginBottom:20}}>
          {activeStores.map(s=>(
            <button key={s.id} className={`store-btn ${selectedStore===s.id?'active':''}`}
              onClick={()=>setSelectedStore(s.id)}>
              {selectedStore===s.id?'‚úì ':''}{s.name}
            </button>
          ))}
        </div>

        <div className="bulk-counter">
          <div className="bulk-count">{scanned.length}</div>
          <div className="bulk-label">kod√≥w zeskanowanych</div>
        </div>

        <BarcodeScanner active={scannerActive} onDetected={handleDetected} continuous={true}/>
        <button className="btn-primary" onClick={()=>setScannerActive(v=>!v)}>
          {scannerActive?'‚èπ Zatrzymaj skaner':'üì∑ Uruchom skaner'}
        </button>

        {scanned.length > 0 && (
          <>
            <div className="section-label" style={{marginTop:16}}>Ostatnie</div>
            {[...scanned].reverse().slice(0,5).map((x,i)=>(
              <div key={i} className="barcode-row">
                <div>
                  <div className="barcode-code">{x.barcode}</div>
                  <div className="barcode-store">{x.store_name}</div>
                </div>
              </div>
            ))}
            <button className="btn-secondary" onClick={()=>{ setScanned([]); showToast('Lista wyczyszczona'); }}>
              üóë Wyczy≈õƒá sesjƒô
            </button>
          </>
        )}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ SavedBarcodesScreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function SavedBarcodesScreen({ stores, onBack }) {
  const [items, setItems] = useState([]);
  const [filterStore, setFilterStore] = useState('all');
  const [configBarcode, setConfigBarcode] = useState(null);
  const [configStoreId, setConfigStoreId] = useState(null);
  const [toast, setToast] = useState('');

  function showToast(msg) { setToast(msg); setTimeout(()=>setToast(''),2500); }

  useEffect(() => {
    const saved = JSON.parse(localStorage.getItem(SAVED_KEY)||'[]');
    setItems(saved);
  }, []);

  function removeItem(barcode, store_id) {
    const updated = items.filter(x=>!(x.barcode===barcode&&x.store_id===store_id));
    setItems(updated);
    localStorage.setItem(SAVED_KEY, JSON.stringify(updated));
  }

  const storeGroups = [...new Set(items.map(x=>x.store_id))];
  const filtered = filterStore==='all' ? items : items.filter(x=>x.store_id===Number(filterStore));

  if (configBarcode) return (
    <ConfigScreen barcode={configBarcode} stores={stores}
      onSaved={(status)=>{
        removeItem(configBarcode, configStoreId);
        setConfigBarcode(null);
        showToast(status==='created'?'‚úì Dodano!':'‚úì Zaktualizowano!');
      }}
      onBack={()=>setConfigBarcode(null)}/>
  );

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Toast msg={toast}/>
      <div className="header">
        <div className="header-top">
          <button className="back-btn" onClick={onBack} style={{marginRight:8}}>‚Üê</button>
          <div className="logo-icon">üóÇ</div>
          <div><div className="logo-text">NutriCart</div><div className="logo-sub">Zapisane kody</div></div>
        </div>
      </div>
      <div className="screen">
        {items.length === 0 ? (
          <div style={{textAlign:'center',padding:'60px 20px',color:'var(--muted)'}}>
            <div style={{fontSize:48,marginBottom:12}}>üì≠</div>
            <div style={{fontSize:14}}>Brak zapisanych kod√≥w.<br/>U≈ºyj "Skanowanie wielu" aby zapisaƒá kody z sesji.</div>
          </div>
        ) : (
          <>
            <div className="filter-bar">
              <button className={`filter-chip ${filterStore==='all'?'active':''}`} onClick={()=>setFilterStore('all')}>
                Wszystkie ({items.length})
              </button>
              {storeGroups.map(sid=>{
                const s = stores.find(x=>x.id===sid);
                const cnt = items.filter(x=>x.store_id===sid).length;
                return <button key={sid} className={`filter-chip ${filterStore===String(sid)?'active':''}`}
                  onClick={()=>setFilterStore(String(sid))}>{s?.name||sid} ({cnt})</button>;
              })}
            </div>

            {filtered.map((x,i)=>(
              <div key={i} className="barcode-row">
                <div style={{flex:1}}>
                  <div className="barcode-code">{x.barcode}</div>
                  <div className="barcode-store">{x.store_name} ¬∑ {new Date(x.ts).toLocaleDateString('pl-PL')}</div>
                </div>
                <div style={{display:'flex',gap:6}}>
                  <button className="add-btn-sm" onClick={()=>{ setConfigStoreId(x.store_id); setConfigBarcode(x.barcode); }}>
                    + Dodaj
                  </button>
                  <button className="add-btn-sm" style={{borderColor:'var(--red)',color:'var(--red)',background:'rgba(248,113,113,0.08)'}}
                    onClick={()=>{ removeItem(x.barcode, x.store_id); showToast('Usuniƒôto'); }}>
                    ‚úï
                  </button>
                </div>
              </div>
            ))}
          </>
        )}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ ProductsScreen ‚Äî przeglƒÖdanie i modyfikacje ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function ProductsScreen({ stores, onBack }) {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  const [filterStatus, setFilterStatus] = useState('all');
  const [filterStore, setFilterStore] = useState('all');
  const [editProduct, setEditProduct] = useState(null); // { id, status, is_ready_to_eat, store_ids }
  const [saving, setSaving] = useState(false);
  const [toast, setToast] = useState('');

  function showToast(msg) { setToast(msg); setTimeout(()=>setToast(''),2500); }

  useEffect(()=>{ loadProducts(); }, []);

  async function loadProducts() {
    setLoading(true);
    try {
      const res = await fetch(`${API}/products`);
      const data = await res.json();
      setProducts(data);
    } catch(e) {}
    finally { setLoading(false); }
  }

  async function saveEdit() {
    setSaving(true);
    try {
      // Aktualizuj status i is_ready_to_eat
      await fetch(`${API}/products/${editProduct.id}/quick-update`, {
        method:'PATCH', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ status: editProduct.status, is_ready_to_eat: editProduct.is_ready_to_eat })
      });
      // Aktualizuj sklepy przez PUT
      const existing = products.find(p=>p.id===editProduct.id);
      await fetch(`${API}/products/${editProduct.id}`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ ...existing, store_ids: editProduct.store_ids })
      });
      await loadProducts();
      setEditProduct(null);
      showToast('‚úì Zapisano');
    } catch(e) { showToast('B≈ÇƒÖd zapisu'); }
    finally { setSaving(false); }
  }

  const filtered = products.filter(p => {
    if (search && !p.name.toLowerCase().includes(search.toLowerCase()) && !(p.brand||'').toLowerCase().includes(search.toLowerCase())) return false;
    if (filterStatus !== 'all' && p.status !== filterStatus) return false;
    if (filterStore !== 'all' && !(p.store_ids||[]).includes(Number(filterStore))) return false;
    return true;
  });

  if (editProduct) {
    const storeList = stores.filter(s=>s.status!=='deleted');
    return (
      <div style={{minHeight:'100vh',background:'var(--bg)'}}>
        <Toast msg={toast}/>
        <div className="header">
          <div className="header-top">
            <button className="back-btn" onClick={()=>setEditProduct(null)} style={{marginRight:8}}>‚Üê</button>
            <div className="logo-icon">‚úèÔ∏è</div>
            <div><div className="logo-text">NutriCart</div><div className="logo-sub">Edytuj produkt</div></div>
          </div>
        </div>
        <div className="screen">
          <div style={{fontFamily:'Syne',fontSize:18,fontWeight:700,marginBottom:4}}>{editProduct.name}</div>
          {editProduct.brand&&<div style={{fontSize:12,color:'var(--muted)',marginBottom:16}}>{editProduct.brand}</div>}

          <div className="section-label">Sklepy</div>
          <div className="store-grid" style={{marginBottom:24}}>
            {storeList.map(s=>(
              <button key={s.id} className={`store-btn ${(editProduct.store_ids||[]).includes(s.id)?'active':''}`}
                onClick={()=>setEditProduct(prev=>({...prev, store_ids: (prev.store_ids||[]).includes(s.id) ? prev.store_ids.filter(x=>x!==s.id) : [...(prev.store_ids||[]),s.id]}))}>
                {(editProduct.store_ids||[]).includes(s.id)?'‚úì ':''}{s.name}
              </button>
            ))}
          </div>

          <div className="section-label">Gotowy do spo≈ºycia?</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:24}}>
            {[{v:1,l:'‚úÖ Tak'},{v:0,l:'üç≥ Nie'},{v:null,l:'‚ùì Nie wiem'}].map(opt=>(
              <button key={String(opt.v)} onClick={()=>setEditProduct(prev=>({...prev,is_ready_to_eat:opt.v}))}
                style={{padding:'10px 6px',borderRadius:12,border:'none',cursor:'pointer',
                  background:editProduct.is_ready_to_eat===opt.v?'rgba(34,211,238,0.12)':'var(--surface)',
                  outline:editProduct.is_ready_to_eat===opt.v?'2px solid var(--accent)':'1px solid var(--border)',
                  color:editProduct.is_ready_to_eat===opt.v?'var(--accent)':'var(--muted)',textAlign:'center'}}>
                <div style={{fontSize:13,fontWeight:600}}>{opt.l}</div>
              </button>
            ))}
          </div>

          <div className="section-label">Status</div>
          <div style={{display:'flex',flexDirection:'column',gap:8,marginBottom:28}}>
            {[
              {v:'active',l:'üü¢ Aktywny'},
              {v:'inactive_incomplete',l:'üî¥ Nieaktywny ‚Äî niekompletny'},
              {v:'inactive_deleted',l:'‚ö´ Nieaktywny ‚Äî usuniƒôty'},
            ].map(opt=>(
              <button key={opt.v} onClick={()=>setEditProduct(prev=>({...prev,status:opt.v}))}
                style={{padding:'12px',borderRadius:12,border:'none',cursor:'pointer',textAlign:'left',
                  background:editProduct.status===opt.v?'rgba(34,211,238,0.08)':'var(--surface)',
                  outline:editProduct.status===opt.v?'2px solid var(--accent)':'1px solid var(--border)',
                  color:editProduct.status===opt.v?'var(--text)':'var(--muted)',fontSize:14,fontWeight:editProduct.status===opt.v?600:400}}>
                {opt.l}
              </button>
            ))}
          </div>

          <button className="btn-primary" onClick={saveEdit} disabled={saving}>{saving?'Zapisujƒô...':'üíæ Zapisz zmiany'}</button>
          <button className="btn-secondary" onClick={()=>setEditProduct(null)}>Anuluj</button>
        </div>
      </div>
    );
  }

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Toast msg={toast}/>
      <div className="header">
        <div className="header-top">
          <button className="back-btn" onClick={onBack} style={{marginRight:8}}>‚Üê</button>
          <div className="logo-icon">üóÑ</div>
          <div><div className="logo-text">NutriCart</div><div className="logo-sub">Produkty ({filtered.length})</div></div>
        </div>
      </div>
      <div className="screen">
        <input className="search-input" placeholder="üîç Szukaj po nazwie lub marce..." value={search} onChange={e=>setSearch(e.target.value)}/>

        <div className="filter-bar">
          {[['all','Wszystkie'],['active','Aktywne'],['inactive_incomplete','Niekompletne'],['inactive_deleted','Usuniƒôte']].map(([v,l])=>(
            <button key={v} className={`filter-chip ${filterStatus===v?'active':''}`} onClick={()=>setFilterStatus(v)}>{l}</button>
          ))}
        </div>

        <div className="filter-bar">
          <button className={`filter-chip ${filterStore==='all'?'active':''}`} onClick={()=>setFilterStore('all')}>Wszystkie sklepy</button>
          {stores.map(s=>(
            <button key={s.id} className={`filter-chip ${filterStore===String(s.id)?'active':''}`}
              onClick={()=>setFilterStore(String(s.id))}>{s.name}</button>
          ))}
        </div>

        {loading ? <Dots/> : filtered.length === 0 ? (
          <div style={{textAlign:'center',padding:'40px 0',color:'var(--muted)',fontSize:14}}>Brak wynik√≥w</div>
        ) : (
          filtered.map(p=>(
            <div key={p.id} className="product-row" onClick={()=>setEditProduct({...p})}>
              {p.image_url ? <img className="product-row-img" src={p.image_url} alt={p.name} style={{width:44,height:44,borderRadius:10,objectFit:'contain',background:'var(--surface2)'}}/>
                : <div className="product-row-img">ü•´</div>}
              <div className="product-row-info">
                <div className="product-row-name">{p.name}</div>
                <div className="product-row-meta">
                  {p.brand&&<>{p.brand} ¬∑ </>}
                  {p.calories_per_100g&&<>{Math.round(p.calories_per_100g)} kcal ¬∑ </>}
                  {p.category||'inne'}
                </div>
              </div>
              <StatusBadge status={p.status}/>
            </div>
          ))
        )}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ StoresScreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function StoresScreen({ stores, reloadStores, onBack }) {
  const [name, setName] = useState('');
  const [saving, setSaving] = useState(false);
  const [toast, setToast] = useState('');

  function showToast(msg) { setToast(msg); setTimeout(()=>setToast(''),2000); }

  async function addStore() {
    if (!name.trim()) return;
    setSaving(true);
    try {
      await fetch(`${API}/stores`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name:name.trim()}) });
      setName(''); reloadStores(); showToast('‚úì Sklep dodany');
    } catch(e) { showToast('B≈ÇƒÖd'); }
    finally { setSaving(false); }
  }

  async function toggleStatus(store) {
    const next = store.status === 'active' ? 'inactive' : store.status === 'inactive' ? 'deleted' : 'active';
    await fetch(`${API}/stores/${store.id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status:next}) });
    reloadStores();
  }

  const statusLabel = { active:'üü¢ Aktywny', inactive:'üî¥ Nieaktywny', deleted:'‚ö´ Usuniƒôty' };
  const nextLabel = { active:'‚Üí Dezaktywuj', inactive:'‚Üí Usu≈Ñ', deleted:'‚Üí Aktywuj' };

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Toast msg={toast}/>
      <div className="header">
        <div className="header-top">
          <button className="back-btn" onClick={onBack} style={{marginRight:8}}>‚Üê</button>
          <div className="logo-icon">üè™</div>
          <div><div className="logo-text">NutriCart</div><div className="logo-sub">Sklepy</div></div>
        </div>
      </div>
      <div className="screen">
        <div className="section-label">Dodaj nowy sklep</div>
        <div className="manual-input-wrap" style={{marginBottom:24}}>
          <input className="manual-input" placeholder="Nazwa sklepu..." value={name}
            onChange={e=>setName(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addStore()}/>
          <button className="manual-btn" onClick={addStore} disabled={saving||!name.trim()}>+</button>
        </div>

        <div className="section-label">Wszystkie sklepy</div>
        {stores.map(s=>(
          <div key={s.id} className="store-row">
            <div>
              <div className="store-row-name">{s.name}</div>
              <div style={{fontSize:12,color:'var(--muted)',marginTop:3}}>{statusLabel[s.status]||s.status}</div>
            </div>
            <button className="add-btn-sm" onClick={()=>toggleStatus(s)}>{nextLabel[s.status]}</button>
          </div>
        ))}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ Main Menu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const MENU = [
  { id:'single',  icon:'üì∑', title:'Skanowanie produktu',    sub:'Skanuj i od razu konfiguruj' },
  { id:'bulk',    icon:'üì¶', title:'Skanowanie wielu',        sub:'Zapisuj kody na p√≥≈∫niej' },
  { id:'products',icon:'üóÑ', title:'Produkty',               sub:'PrzeglƒÖdaj i modyfikuj' },
  { id:'saved',   icon:'üóÇ', title:'Zapisane kody',           sub:'Z poprzednich sesji' },
  { id:'stores',  icon:'üè™', title:'Sklepy',                  sub:'ZarzƒÖdzaj sklepami' },
];

function App() {
  const [screen, setScreen] = useState('menu');
  const [stores, reloadStores] = useStores();

  const screenProps = { stores, onBack:()=>setScreen('menu') };

  if (screen === 'single')   return <SingleScanScreen {...screenProps}/>;
  if (screen === 'bulk')     return <BulkScanScreen {...screenProps}/>;
  if (screen === 'products') return <ProductsScreen {...screenProps}/>;
  if (screen === 'saved')    return <SavedBarcodesScreen {...screenProps}/>;
  if (screen === 'stores')   return <StoresScreen {...screenProps} reloadStores={reloadStores}/>;

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <div className="header">
        <div className="header-top">
          <div className="logo-icon">üì°</div>
          <div><div className="logo-text">NutriCart</div><div className="logo-sub">Product Scanner</div></div>
        </div>
      </div>
      <div className="menu-grid">
        {MENU.map(m=>(
          <button key={m.id} className="menu-card" onClick={()=>setScreen(m.id)}>
            <div className="menu-card-icon">{m.icon}</div>
            <div className="menu-card-title">{m.title}</div>
            <div className="menu-card-sub">{m.sub}</div>
          </button>
        ))}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
