<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="theme-color" content="#0f172a" />
  <title>NutriCart Scanner</title>
  <link rel="manifest" href="#" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@700;800&family=DM+Sans:wght@300;400;500&display=swap');

    :root {
      --bg: #0a0f1e;
      --surface: #111827;
      --surface2: #1e2a3a;
      --accent: #22d3ee;
      --accent2: #a78bfa;
      --green: #4ade80;
      --red: #f87171;
      --yellow: #fbbf24;
      --text: #f1f5f9;
      --muted: #64748b;
      --border: #1e3a5f;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    #root {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      position: relative;
    }

    /* Header */
    .header {
      padding: 20px 16px 16px;
      background: linear-gradient(180deg, #0f1729 0%, transparent 100%);
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(34, 211, 238, 0.1);
    }

    .header-top {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }

    .logo-text {
      font-family: 'Syne', sans-serif;
      font-size: 20px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .logo-sub {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-top: 1px;
    }

    /* Screen */
    .screen { padding: 16px; }

    /* Store selector */
    .section-label {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 10px;
    }

    .store-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 24px;
    }

    .store-btn {
      padding: 10px 6px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .store-btn.active {
      border-color: var(--accent);
      background: rgba(34, 211, 238, 0.08);
      color: var(--accent);
      font-weight: 500;
    }

    /* Scanner area */
    .scanner-box {
      position: relative;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 16px;
      aspect-ratio: 4/3;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scanner-box video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .scanner-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .scan-frame {
      width: 200px;
      height: 120px;
      position: relative;
    }

    .scan-frame::before, .scan-frame::after,
    .scan-frame-inner::before, .scan-frame-inner::after {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      border-color: var(--accent);
      border-style: solid;
    }

    .scan-frame::before { top: 0; left: 0; border-width: 2px 0 0 2px; border-radius: 4px 0 0 0; }
    .scan-frame::after { top: 0; right: 0; border-width: 2px 2px 0 0; border-radius: 0 4px 0 0; }
    .scan-frame-inner::before { bottom: 0; left: 0; border-width: 0 0 2px 2px; border-radius: 0 0 0 4px; }
    .scan-frame-inner::after { bottom: 0; right: 0; border-width: 0 2px 2px 0; border-radius: 0 0 4px 0; }

    .scan-line {
      position: absolute;
      left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      animation: scanLine 2s ease-in-out infinite;
      top: 0;
    }

    @keyframes scanLine {
      0% { top: 0%; opacity: 1; }
      50% { top: 100%; opacity: 0.5; }
      100% { top: 0%; opacity: 1; }
    }

    .scan-hint {
      margin-top: 16px;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: rgba(34, 211, 238, 0.7);
      letter-spacing: 1px;
    }

    .scanner-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 40px;
    }

    .scanner-icon {
      font-size: 48px;
      opacity: 0.4;
    }

    .scanner-start-text {
      font-size: 14px;
      color: var(--muted);
      text-align: center;
      line-height: 1.6;
    }

    /* Buttons */
    .btn-primary {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), #0891b2);
      color: #0a0f1e;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 15px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-secondary {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      background: transparent;
      color: var(--accent);
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      font-size: 14px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 10px;
    }

    /* Manual input */
    .manual-input-wrap {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .manual-input {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .manual-input:focus { border-color: var(--accent); }
    .manual-input::placeholder { color: var(--muted); }

    .manual-btn {
      padding: 12px 16px;
      border-radius: 12px;
      background: var(--accent);
      color: #0a0f1e;
      font-weight: 700;
      border: none;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
    }

    /* Result card */
    .result-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 16px;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-status {
      padding: 10px 16px;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .result-status.created { background: rgba(74, 222, 128, 0.1); color: var(--green); }
    .result-status.existing { background: rgba(167, 139, 250, 0.1); color: var(--accent2); }
    .result-status.error { background: rgba(248, 113, 113, 0.1); color: var(--red); }

    .result-body {
      padding: 16px;
    }

    .result-top {
      display: flex;
      gap: 12px;
      margin-bottom: 14px;
    }

    .product-img {
      width: 70px;
      height: 70px;
      border-radius: 12px;
      object-fit: contain;
      background: var(--surface2);
      flex-shrink: 0;
    }

    .product-img-placeholder {
      width: 70px;
      height: 70px;
      border-radius: 12px;
      background: var(--surface2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      flex-shrink: 0;
    }

    .product-info { flex: 1; min-width: 0; }

    .product-brand {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--accent);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .product-name {
      font-family: 'Syne', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
      line-height: 1.3;
    }

    .product-category {
      font-size: 12px;
      color: var(--muted);
    }

    .nutriscore {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 6px;
      font-family: 'Syne', sans-serif;
      font-size: 13px;
      font-weight: 800;
      margin-left: 8px;
    }

    .nutriscore-a { background: #1a7a1a; color: white; }
    .nutriscore-b { background: #5aaa15; color: white; }
    .nutriscore-c { background: #f0a500; color: white; }
    .nutriscore-d { background: #e6791f; color: white; }
    .nutriscore-e { background: #cc1212; color: white; }

    /* Macros */
    .macros-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 14px;
    }

    .macro-box {
      background: var(--surface2);
      border-radius: 10px;
      padding: 10px 6px;
      text-align: center;
    }

    .macro-val {
      font-family: 'DM Mono', monospace;
      font-size: 15px;
      font-weight: 500;
      color: var(--text);
    }

    .macro-lbl {
      font-size: 10px;
      color: var(--muted);
      margin-top: 3px;
    }

    .macro-kcal .macro-val { color: var(--accent); }

    /* Barcode display */
    .barcode-display {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      margin-top: 8px;
    }

    /* Divider */
    .divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 13px;
      z-index: 100;
      animation: fadeInOut 2.5s ease forwards;
      white-space: nowrap;
      backdrop-filter: blur(8px);
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      75% { opacity: 1; }
      100% { opacity: 0; transform: translateX(-50%) translateY(-5px); }
    }

    .loading-dots {
      display: flex;
      gap: 6px;
      justify-content: center;
      padding: 20px;
    }

    .loading-dots span {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: bounce 1.2s infinite;
    }

    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }
  
    /* ‚îÄ‚îÄ Menu g≈Ç√≥wne ‚îÄ‚îÄ */
    .menu-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 16px;
    }

    .menu-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 20px 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      text-align: left;
      min-height: 120px;
    }

    .menu-card:active { transform: scale(0.97); }

    .menu-card:hover {
      border-color: var(--accent);
      background: rgba(34, 211, 238, 0.04);
    }

    .menu-card-icon {
      font-size: 28px;
      line-height: 1;
    }

    .menu-card-title {
      font-family: 'Syne', sans-serif;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      line-height: 1.2;
    }

    .menu-card-sub {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }

    /* ‚îÄ‚îÄ Back button ‚îÄ‚îÄ */
    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      color: var(--muted);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      cursor: pointer;
      padding: 4px 0;
      margin-left: -2px;
    }

    /* ‚îÄ‚îÄ Product list ‚îÄ‚îÄ */
    .product-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(30, 58, 95, 0.5);
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .product-row:active { opacity: 0.7; }

    .product-row-img {
      width: 44px; height: 44px;
      border-radius: 10px;
      background: var(--surface2);
      object-fit: contain;
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px;
    }

    .product-row-info { flex: 1; min-width: 0; }

    .product-row-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-row-meta {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .status-badge {
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      letter-spacing: 1px;
      padding: 3px 7px;
      border-radius: 6px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .status-badge.active { background: rgba(74,222,128,0.12); color: var(--green); }
    .status-badge.inactive { background: rgba(248,113,113,0.12); color: var(--red); }
    .status-badge.deleted { background: rgba(100,116,139,0.15); color: var(--muted); }

    /* ‚îÄ‚îÄ Filter bar ‚îÄ‚îÄ */
    .filter-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
      overflow-x: auto;
      padding-bottom: 4px;
      scrollbar-width: none;
    }
    .filter-bar::-webkit-scrollbar { display: none; }

    .filter-chip {
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.15s;
      flex-shrink: 0;
    }

    .filter-chip.active {
      border-color: var(--accent);
      background: rgba(34,211,238,0.1);
      color: var(--accent);
    }

    /* ‚îÄ‚îÄ Saved barcodes ‚îÄ‚îÄ */
    .barcode-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .barcode-code {
      font-family: 'DM Mono', monospace;
      font-size: 14px;
      color: var(--accent);
    }

    .barcode-store {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .add-btn-sm {
      padding: 7px 14px;
      border-radius: 8px;
      background: rgba(34,211,238,0.1);
      border: 1px solid var(--accent);
      color: var(--accent);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ Search input ‚îÄ‚îÄ */
    .search-input {
      width: 100%;
      padding: 11px 14px;
      border-radius: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      outline: none;
      margin-bottom: 14px;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--accent); }
    .search-input::placeholder { color: var(--muted); }

    /* ‚îÄ‚îÄ Store row ‚îÄ‚îÄ */
    .store-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      margin-bottom: 10px;
    }

    .store-row-name {
      font-weight: 600;
      font-size: 15px;
    }

    /* Scan bulk counter */
    .bulk-counter {
      background: var(--surface2);
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      margin-bottom: 16px;
    }

    .bulk-count {
      font-family: 'Syne', sans-serif;
      font-size: 48px;
      font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }

    .bulk-label {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 2px;
      color: var(--muted);
      margin-top: 6px;
    }

    /* ‚îÄ‚îÄ Meal Planner (desktop-first) ‚îÄ‚îÄ */
    @media (min-width: 768px) {
      #root { max-width: 100%; }
    }

    .planner-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto 1fr;
      gap: 0;
      height: calc(100vh - 65px);
    }

    @media (max-width: 767px) {
      .planner-layout {
        grid-template-columns: 1fr;
        height: auto;
      }
    }

    .planner-left {
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .planner-right {
      overflow-y: auto;
      padding: 24px;
      background: rgba(10, 15, 30, 0.6);
    }

    .planner-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      font-size: 18px;
      font-weight: 700;
      outline: none;
      transition: border-color 0.2s;
    }
    .planner-input:focus { border-color: var(--accent); }
    .planner-input::placeholder { color: var(--muted); font-weight: 400; font-size: 15px; font-family: 'DM Sans', sans-serif; }

    .planner-meal-type {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .meal-type-btn {
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .meal-type-btn.active {
      border-color: var(--accent2);
      background: rgba(167,139,250,0.12);
      color: var(--accent2);
      font-weight: 600;
    }

    /* Ingredient row in planner */
    .ingredient-row {
      display: grid;
      grid-template-columns: 1fr 80px 90px 32px;
      gap: 8px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(30,58,95,0.4);
      animation: slideUp 0.2s ease;
    }

    .ingredient-select {
      padding: 9px 12px;
      border-radius: 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 13px;
      outline: none;
      width: 100%;
      cursor: pointer;
    }
    .ingredient-select:focus { border-color: var(--accent); }

    .ingredient-qty {
      padding: 9px 10px;
      border-radius: 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      outline: none;
      width: 100%;
      text-align: right;
    }
    .ingredient-qty:focus { border-color: var(--accent); }

    .ingredient-unit {
      padding: 9px 8px;
      border-radius: 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 12px;
      outline: none;
      width: 100%;
      cursor: pointer;
    }

    .remove-btn {
      width: 32px; height: 32px;
      border-radius: 8px;
      border: 1px solid rgba(248,113,113,0.2);
      background: rgba(248,113,113,0.06);
      color: var(--red);
      font-size: 16px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }
    .remove-btn:hover { background: rgba(248,113,113,0.15); }

    /* Nutrition summary panel */
    .nutrition-hero {
      background: linear-gradient(135deg, rgba(34,211,238,0.08), rgba(167,139,250,0.08));
      border: 1px solid rgba(34,211,238,0.15);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      text-align: center;
    }

    .nutrition-hero-kcal {
      font-family: 'Syne', sans-serif;
      font-size: 64px;
      font-weight: 800;
      line-height: 1;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .nutrition-hero-label {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 2px;
      color: var(--muted);
      margin-top: 4px;
    }

    .macro-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 16px;
    }

    .macro-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }

    .macro-card-val {
      font-family: 'DM Mono', monospace;
      font-size: 22px;
      font-weight: 500;
    }

    .macro-card-lbl {
      font-size: 10px;
      color: var(--muted);
      margin-top: 3px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Micro nutrients table */
    .micro-section {
      background: var(--surface);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .micro-section-title {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--accent);
      padding: 12px 16px 8px;
      border-bottom: 1px solid var(--border);
    }

    .micro-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      border-bottom: 1px solid rgba(30,58,95,0.3);
      font-size: 13px;
    }
    .micro-row:last-child { border-bottom: none; }

    .micro-name { color: var(--muted); }
    .micro-val { font-family: 'DM Mono', monospace; color: var(--text); }

    .micro-bar-wrap {
      width: 60px;
      height: 4px;
      background: var(--surface2);
      border-radius: 2px;
      overflow: hidden;
      margin-left: 12px;
      flex-shrink: 0;
    }
    .micro-bar {
      height: 100%;
      border-radius: 2px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width 0.4s ease;
    }

    /* Ingredient summary rows */
    .ingr-summary-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 8px 16px;
      border-bottom: 1px solid rgba(30,58,95,0.3);
      font-size: 12px;
      gap: 8px;
    }
    .ingr-summary-row:last-child { border-bottom: none; }

    .save-meal-btn {
      width: 100%;
      padding: 15px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent2), #7c3aed);
      color: white;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 15px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.5px;
      margin-top: 8px;
    }
    .save-meal-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .save-meal-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(167,139,250,0.3); }

    .planner-section-label {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--accent2);
      margin-bottom: 10px;
    }

    .add-ingredient-btn {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px dashed var(--border);
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      margin-top: 8px;
    }
    .add-ingredient-btn:hover { border-color: var(--accent); color: var(--accent); }

    .dietary-flags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
    }

    .dietary-flag {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    .dietary-flag.yes { background: rgba(74,222,128,0.12); color: var(--green); border: 1px solid rgba(74,222,128,0.2); }
    .dietary-flag.no  { background: rgba(248,113,113,0.08); color: var(--muted); border: 1px solid rgba(30,58,95,0.4); text-decoration: line-through; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel" data-presets="react">
const { useState, useEffect, useRef } = React;
const API = 'https://nutricart-production.up.railway.app/api';

// ‚îÄ‚îÄ Globals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function useStores() {
  const [stores, setStores] = useState([]);
  const reload = () => fetch(`${API}/stores?all=1`).then(r=>r.json()).then(setStores).catch(()=>{});
  useEffect(()=>{ reload(); }, []);
  return [stores, reload];
}

// ‚îÄ‚îÄ Ma≈Çe komponenty ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function NutriScore({ grade }) {
  if (!grade) return null;
  const g = grade.toUpperCase();
  return <span className={`nutriscore nutriscore-${g.toLowerCase()}`}>N{g}</span>;
}

function MacroBox({ val, lbl, className }) {
  return (
    <div className={`macro-box ${className||''}`}>
      <div className="macro-val">{val!=null ? Math.round(val) : '‚Äî'}</div>
      <div className="macro-lbl">{lbl}</div>
    </div>
  );
}

function Toast({ msg }) {
  if (!msg) return null;
  return <div className="toast">{msg}</div>;
}

function Dots() {
  return <div className="loading-dots"><span/><span/><span/></div>;
}

function BackBtn({ onBack, label = '‚Üê Wr√≥ƒá' }) {
  return (
    <button className="back-btn" onClick={onBack}>
      <span style={{fontSize:18}}>‚Üê</span> {label}
    </button>
  );
}

function Header({ icon, sub, onBack, onHome }) {
  return (
    <div className="header">
      <div className="header-top">
        {onBack && <button className="back-btn" onClick={onBack} style={{marginRight:8}}>‚Üê</button>}
        <div className="logo-icon" onClick={onHome} style={{cursor:onHome?'pointer':'default'}}>{icon}</div>
        <div onClick={onHome} style={{cursor:onHome?'pointer':'default'}}>
          <div className="logo-text">NutriCart</div>
          {sub && <div className="logo-sub">{sub}</div>}
        </div>
      </div>
    </div>
  );
}

function StatusBadge({ status }) {
  const map = { active:'üü¢ aktywny', inactive_incomplete:'üî¥ niekompletny', inactive_deleted:'‚ö´ usuniƒôty', active_store:'üü¢', inactive:'üî¥', deleted:'‚ö´' };
  return <span className={`status-badge ${status?.includes('active') && !status.includes('in') ? 'active' : status?.includes('deleted') ? 'deleted' : 'inactive'}`}>{map[status] || status}</span>;
}

// ‚îÄ‚îÄ BarcodeScanner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function BarcodeScanner({ active, onDetected, continuous = false }) {
  const videoRef = useRef(null);
  const streamRef = useRef(null);
  const rafRef = useRef(null);
  const lastDetected = useRef('');

  useEffect(() => {
    if (active) startCamera(); else stopCamera();
    return () => stopCamera();
  }, [active]);

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } }
      });
      streamRef.current = stream;
      if (videoRef.current) { videoRef.current.srcObject = stream; videoRef.current.play(); }
      if ('BarcodeDetector' in window) {
        const detector = new BarcodeDetector({ formats: ['ean_13','ean_8','code_128','upc_a','upc_e','qr_code'] });
        const scan = async () => {
          if (!videoRef.current) return;
          if (videoRef.current.readyState === videoRef.current.HAVE_ENOUGH_DATA) {
            try {
              const barcodes = await detector.detect(videoRef.current);
              if (barcodes.length > 0) {
                const val = barcodes[0].rawValue;
                if (continuous) {
                  // w trybie bulk ‚Äî zapobiegaj duplikatom przez 2s
                  if (val !== lastDetected.current) {
                    lastDetected.current = val;
                    onDetected(val);
                    setTimeout(() => { lastDetected.current = ''; }, 2000);
                  }
                } else {
                  onDetected(val);
                  return;
                }
              }
            } catch(e) {}
          }
          rafRef.current = requestAnimationFrame(scan);
        };
        videoRef.current.addEventListener('loadeddata', () => { rafRef.current = requestAnimationFrame(scan); });
      }
    } catch(e) { console.error(e); }
  }

  function stopCamera() {
    if (rafRef.current) cancelAnimationFrame(rafRef.current);
    if (streamRef.current) { streamRef.current.getTracks().forEach(t=>t.stop()); streamRef.current = null; }
  }

  return (
    <div className="scanner-box" style={{background:'#000',position:'relative',overflow:'hidden',borderRadius:20,aspectRatio:'4/3',marginBottom:16}}>
      <video ref={videoRef} muted playsInline autoPlay
        style={{width:'100%',height:'100%',objectFit:'cover',display:active?'block':'none'}} />
      {active && (
        <div style={{position:'absolute',inset:0,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',pointerEvents:'none'}}>
          <div className="scan-frame"><div className="scan-frame-inner"/><div className="scan-line"/></div>
          <div className="scan-hint" style={{marginTop:12}}>SKIERUJ KAMERƒò NA KOD KRESKOWY</div>
        </div>
      )}
      {!active && (
        <div className="scanner-placeholder">
          <div className="scanner-icon">üì∑</div>
          <div className="scanner-start-text">Kliknij aby uruchomiƒá kamerƒô</div>
        </div>
      )}
    </div>
  );
}

// ‚îÄ‚îÄ ConfigScreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function ConfigScreen({ barcode, stores, onSaved, onBack, onHome }) {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState('');
  const [isNew, setIsNew] = useState(true);
  const [preview, setPreview] = useState(null);
  const [selectedStores, setSelectedStores] = useState([]);
  const [readyToEat, setReadyToEat] = useState(null);
  const [activate, setActivate] = useState(false);
  const [genericProductId, setGenericProductId] = useState(null);
  const [genericProducts, setGenericProducts] = useState([]);

  useEffect(() => { load(); loadGenerics(); }, [barcode]);

  async function loadGenerics() {
    try {
      const res = await fetch(`${API}/products/generic`);
      setGenericProducts(await res.json());
    } catch(e) {}
  }

  async function load() {
    setLoading(true); setError('');
    try {
      const res = await fetch(`${API}/scan/${barcode}`);
      const data = await res.json();
      if (res.status === 404) { setError('Produkt nie znaleziony w OpenFoodFacts'); setLoading(false); return; }
      if (!res.ok) { setError(data.error || 'B≈ÇƒÖd'); setLoading(false); return; }
      setIsNew(data.is_new);
      setPreview(data.off_preview || data.product);
      if (data.is_new) {
        setSelectedStores([]); setReadyToEat(null); setActivate(false);
      } else {
        const p = data.product;
        setSelectedStores(p.store_ids || []);
        setReadyToEat(p.is_ready_to_eat === 1 ? true : p.is_ready_to_eat === 0 ? false : null);
        setActivate(p.status === 'active');
        setGenericProductId(p.generic_product_id || null);
      }
    } catch(e) { setError('B≈ÇƒÖd po≈ÇƒÖczenia'); }
    finally { setLoading(false); }
  }

  function toggleStore(id) {
    setSelectedStores(prev => prev.includes(id) ? prev.filter(x=>x!==id) : [...prev, id]);
  }

  async function save() {
    setSaving(true); setError('');
    try {
      const body = { ...preview, store_ids: selectedStores,
        status: activate ? 'active' : 'inactive_incomplete',
        is_ready_to_eat: readyToEat === null ? null : (readyToEat ? 1 : 0),
        generic_product_id: genericProductId || null };
      const res = await fetch(`${API}/scan/${barcode}`, {
        method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'B≈ÇƒÖd zapisu');
      onSaved(data.status, data.product);
    } catch(e) { setError(e.message); }
    finally { setSaving(false); }
  }

  if (loading) return <div style={{minHeight:'100vh',background:'var(--bg)',display:'flex',alignItems:'center',justifyContent:'center'}}><Dots/></div>;

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Header icon={isNew?'‚ûï':'‚úèÔ∏è'} sub={isNew?'Nowy produkt':'Edytuj produkt'} onBack={onBack} onHome={onHome}/>
      <div className="screen">
        {error && <div style={{background:'rgba(248,113,113,0.1)',border:'1px solid var(--red)',borderRadius:12,padding:12,marginBottom:16,color:'var(--red)',fontSize:13}}>{error}</div>}
        {preview && (
          <div className="result-card" style={{marginBottom:20}}>
            <div className={`result-status ${isNew?'created':'existing'}`}>{isNew?'üÜï Nowy produkt z OpenFoodFacts':'üì¶ Produkt ju≈º w bazie NutriCart'}</div>
            <div className="result-body">
              <div className="result-top">
                {preview.image_url ? <img className="product-img" src={preview.image_url} alt={preview.name}/> : <div className="product-img-placeholder">ü•´</div>}
                <div className="product-info">
                  {preview.brand && <div className="product-brand">{preview.brand}</div>}
                  <div className="product-name">{preview.name}<NutriScore grade={preview.nutriscore}/></div>
                  <div className="product-category">{preview.category||'inne'}{preview.quantity?` ¬∑ ${preview.quantity}`:''}</div>
                </div>
              </div>
              <div className="macros-grid">
                <MacroBox val={preview.calories_per_100g} lbl="kcal" className="macro-kcal"/>
                <MacroBox val={preview.protein_per_100g} lbl="bia≈Çko g"/>
                <MacroBox val={preview.carbs_per_100g} lbl="wƒôglowo."/>
                <MacroBox val={preview.fat_per_100g} lbl="t≈Çuszcze g"/>
              </div>
              <div className="barcode-display">BARCODE: {barcode}</div>
            </div>
          </div>
        )}

        <div className="section-label">Sklepy</div>
        <div className="store-grid" style={{marginBottom:24}}>
          {stores.filter(s=>s.status!=='deleted').map(s=>(
            <button key={s.id} className={`store-btn ${selectedStores.includes(s.id)?'active':''}`} onClick={()=>toggleStore(s.id)}>
              {selectedStores.includes(s.id)?'‚úì ':''}{s.name}
            </button>
          ))}
        </div>

        <div className="section-label">Gotowy do spo≈ºycia?</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:24}}>
          {[{val:true,label:'‚úÖ Tak',sub:'jogurt, jab≈Çko‚Ä¶'},{val:false,label:'üç≥ Nie',sub:'ry≈º, mƒÖka‚Ä¶'},{val:null,label:'‚ùì Nie wiem',sub:'p√≥≈∫niej'}].map(opt=>(
            <button key={String(opt.val)} onClick={()=>setReadyToEat(opt.val)}
              style={{padding:'12px 6px',borderRadius:12,border:'none',cursor:'pointer',
                background:readyToEat===opt.val?'rgba(34,211,238,0.12)':'var(--surface)',
                outline:readyToEat===opt.val?'2px solid var(--accent)':'1px solid var(--border)',
                color:readyToEat===opt.val?'var(--accent)':'var(--muted)',transition:'all 0.15s',textAlign:'center'}}>
              <div style={{fontSize:13,fontWeight:600}}>{opt.label}</div>
              <div style={{fontSize:10,marginTop:3,opacity:0.7}}>{opt.sub}</div>
            </button>
          ))}
        </div>

        <div className="section-label">Produkt generyczny (opcjonalnie)</div>
        <select className="ingredient-unit" style={{width:'100%',padding:'11px 12px',borderRadius:12,marginBottom:20,fontSize:13}}
          value={genericProductId||''} onChange={e=>setGenericProductId(e.target.value?Number(e.target.value):null)}>
          <option value=''>‚Äî brak powiƒÖzania ‚Äî</option>
          {genericProducts.map(g=>(
            <option key={g.id} value={g.id}>{g.name} ({g.category})</option>
          ))}
        </select>
        {genericProductId && (
          <div style={{fontSize:11,color:'var(--muted)',marginTop:-14,marginBottom:16,paddingLeft:4}}>
            ‚ö† Ten produkt nie bƒôdzie brany do generowania jad≈Çospisu ‚Äî zamiast niego u≈ºywany jest szablon generyczny
          </div>
        )}

        <div className="section-label">Status</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:8,marginBottom:28}}>
          {[{val:true,label:'üü¢ Aktywny',sub:'widoczny w planach'},{val:false,label:'üî¥ Nieaktywny',sub:'wymaga uzupe≈Çnienia'}].map(opt=>(
            <button key={String(opt.val)} onClick={()=>setActivate(opt.val)}
              style={{padding:'12px 8px',borderRadius:12,border:'none',cursor:'pointer',
                background:activate===opt.val?'rgba(74,222,128,0.08)':'var(--surface)',
                outline:activate===opt.val?'2px solid var(--green)':'1px solid var(--border)',
                color:activate===opt.val?'var(--green)':'var(--muted)',transition:'all 0.15s',textAlign:'center'}}>
              <div style={{fontSize:13,fontWeight:600}}>{opt.label}</div>
              <div style={{fontSize:10,marginTop:3,opacity:0.7}}>{opt.sub}</div>
            </button>
          ))}
        </div>

        <button className="btn-primary" onClick={save} disabled={saving}>
          {saving?'Zapisujƒô...':(isNew?'üíæ Dodaj do bazy':'üíæ Zapisz zmiany')}
        </button>
        <button className="btn-secondary" onClick={onBack}>‚Üê Wr√≥ƒá bez zapisywania</button>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ SingleScanScreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function SingleScanScreen({ stores, onBack, onHome }) {
  const [scannerActive, setScannerActive] = useState(false);
  const [manualCode, setManualCode] = useState('');
  const [configBarcode, setConfigBarcode] = useState(null);
  const [toast, setToast] = useState('');

  function showToast(msg) { setToast(msg); setTimeout(()=>setToast(''), 2500); }

  function openConfig(bc) { setScannerActive(false); setConfigBarcode(bc); }

  if (configBarcode) return (
    <ConfigScreen barcode={configBarcode} stores={stores}
      onSaved={(s)=>{ setConfigBarcode(null); setManualCode(''); showToast(s==='created'?'‚úì Dodano!':'‚úì Zapisano!'); }}
      onBack={()=>setConfigBarcode(null)} onHome={onHome}/>
  );

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Toast msg={toast}/>
      <Header icon='üì∑' sub='Skanowanie produktu' onBack={onBack} onHome={onHome}/>
      <div className="screen">
        <BarcodeScanner active={scannerActive} onDetected={openConfig}/>
        <button className="btn-primary" onClick={()=>setScannerActive(v=>!v)}>
          {scannerActive?'‚èπ Zatrzymaj skaner':'üì∑ Uruchom skaner'}
        </button>
        <div className="manual-input-wrap">
          <input className="manual-input" type="text" inputMode="numeric" placeholder="wpisz kod kreskowy..."
            value={manualCode} onChange={e=>setManualCode(e.target.value)}
            onKeyDown={e=>e.key==='Enter'&&manualCode.trim()&&openConfig(manualCode.trim())}/>
          <button className="manual-btn" disabled={!manualCode.trim()} onClick={()=>openConfig(manualCode.trim())}>‚Üí</button>
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ BulkScanScreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const SAVED_KEY = 'nutricart_saved_barcodes';

function BulkScanScreen({ stores, onBack, onHome }) {
  const [selectedStore, setSelectedStore] = useState(null);
  const [scannerActive, setScannerActive] = useState(false);
  const [scanned, setScanned] = useState([]); // { barcode, store_id, store_name, ts }
  const [toast, setToast] = useState('');

  function showToast(msg) { setToast(msg); setTimeout(()=>setToast(''),2000); }

  function handleDetected(bc) {
    if (!selectedStore) { showToast('‚ö† Wybierz sklep przed skanowaniem'); return; }
    setScanned(prev => {
      if (prev.some(x=>x.barcode===bc && x.store_id===selectedStore)) { showToast('Ju≈º zeskanowano'); return prev; }
      const storeName = stores.find(s=>s.id===selectedStore)?.name || '';
      const saved = [...prev, { barcode:bc, store_id:selectedStore, store_name:storeName, ts:Date.now() }];
      // Zapisz do localStorage (merguj z istniejƒÖcymi)
      const existing = JSON.parse(localStorage.getItem(SAVED_KEY)||'[]');
      const merged = [...existing.filter(x=>!(x.barcode===bc&&x.store_id===selectedStore)), { barcode:bc, store_id:selectedStore, store_name:storeName, ts:Date.now() }];
      localStorage.setItem(SAVED_KEY, JSON.stringify(merged));
      showToast(`‚úì ${bc}`);
      return saved;
    });
  }

  const activeStores = stores.filter(s=>s.status!=='deleted');

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Toast msg={toast}/>
      <Header icon='üì¶' sub='Skanowanie wielu' onBack={onBack} onHome={onHome}/>
      <div className="screen">
        <div className="section-label">Sklep</div>
        <div className="store-grid" style={{marginBottom:20}}>
          {activeStores.map(s=>(
            <button key={s.id} className={`store-btn ${selectedStore===s.id?'active':''}`}
              onClick={()=>setSelectedStore(s.id)}>
              {selectedStore===s.id?'‚úì ':''}{s.name}
            </button>
          ))}
        </div>

        <div className="bulk-counter">
          <div className="bulk-count">{scanned.length}</div>
          <div className="bulk-label">kod√≥w zeskanowanych</div>
        </div>

        <BarcodeScanner active={scannerActive} onDetected={handleDetected} continuous={true}/>
        <button className="btn-primary" onClick={()=>setScannerActive(v=>!v)}>
          {scannerActive?'‚èπ Zatrzymaj skaner':'üì∑ Uruchom skaner'}
        </button>

        {scanned.length > 0 && (
          <>
            <div className="section-label" style={{marginTop:16}}>Ostatnie</div>
            {[...scanned].reverse().slice(0,5).map((x,i)=>(
              <div key={i} className="barcode-row">
                <div>
                  <div className="barcode-code">{x.barcode}</div>
                  <div className="barcode-store">{x.store_name}</div>
                </div>
              </div>
            ))}
            <button className="btn-secondary" onClick={()=>{ setScanned([]); showToast('Lista wyczyszczona'); }}>
              üóë Wyczy≈õƒá sesjƒô
            </button>
          </>
        )}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ SavedBarcodesScreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function SavedBarcodesScreen({ stores, onBack, onHome }) {
  const [items, setItems] = useState([]);
  const [filterStore, setFilterStore] = useState('all');
  const [configBarcode, setConfigBarcode] = useState(null);
  const [configStoreId, setConfigStoreId] = useState(null);
  const [toast, setToast] = useState('');

  function showToast(msg) { setToast(msg); setTimeout(()=>setToast(''),2500); }

  useEffect(() => {
    const saved = JSON.parse(localStorage.getItem(SAVED_KEY)||'[]');
    setItems(saved);
  }, []);

  function removeItem(barcode, store_id) {
    const updated = items.filter(x=>!(x.barcode===barcode&&x.store_id===store_id));
    setItems(updated);
    localStorage.setItem(SAVED_KEY, JSON.stringify(updated));
  }

  const storeGroups = [...new Set(items.map(x=>x.store_id))];
  const filtered = filterStore==='all' ? items : items.filter(x=>x.store_id===Number(filterStore));

  if (configBarcode) return (
    <ConfigScreen barcode={configBarcode} stores={stores}
      onSaved={(status)=>{
        removeItem(configBarcode, configStoreId);
        setConfigBarcode(null);
        showToast(status==='created'?'‚úì Dodano!':'‚úì Zaktualizowano!');
      }}
      onBack={()=>setConfigBarcode(null)} onHome={onHome}/>
  );

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Toast msg={toast}/>
      <Header icon='üóÇ' sub='Zapisane kody' onBack={onBack} onHome={onHome}/>
      <div className="screen">
        {items.length === 0 ? (
          <div style={{textAlign:'center',padding:'60px 20px',color:'var(--muted)'}}>
            <div style={{fontSize:48,marginBottom:12}}>üì≠</div>
            <div style={{fontSize:14}}>Brak zapisanych kod√≥w.<br/>U≈ºyj "Skanowanie wielu" aby zapisaƒá kody z sesji.</div>
          </div>
        ) : (
          <>
            <div className="filter-bar">
              <button className={`filter-chip ${filterStore==='all'?'active':''}`} onClick={()=>setFilterStore('all')}>
                Wszystkie ({items.length})
              </button>
              {storeGroups.map(sid=>{
                const s = stores.find(x=>x.id===sid);
                const cnt = items.filter(x=>x.store_id===sid).length;
                return <button key={sid} className={`filter-chip ${filterStore===String(sid)?'active':''}`}
                  onClick={()=>setFilterStore(String(sid))}>{s?.name||sid} ({cnt})</button>;
              })}
            </div>

            {filtered.map((x,i)=>(
              <div key={i} className="barcode-row">
                <div style={{flex:1}}>
                  <div className="barcode-code">{x.barcode}</div>
                  <div className="barcode-store">{x.store_name} ¬∑ {new Date(x.ts).toLocaleDateString('pl-PL')}</div>
                </div>
                <div style={{display:'flex',gap:6}}>
                  <button className="add-btn-sm" onClick={()=>{ setConfigStoreId(x.store_id); setConfigBarcode(x.barcode); }}>
                    + Dodaj
                  </button>
                  <button className="add-btn-sm" style={{borderColor:'var(--red)',color:'var(--red)',background:'rgba(248,113,113,0.08)'}}
                    onClick={()=>{ removeItem(x.barcode, x.store_id); showToast('Usuniƒôto'); }}>
                    ‚úï
                  </button>
                </div>
              </div>
            ))}
          </>
        )}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ ProductsScreen ‚Äî przeglƒÖdanie i modyfikacje ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function ProductsScreen({ stores, onBack, onHome }) {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  const [filterStatus, setFilterStatus] = useState('all');
  const [filterStore, setFilterStore] = useState('all');
  const [editProduct, setEditProduct] = useState(null);
  const [sortBy, setSortBy] = useState('date_desc');
  const [saving, setSaving] = useState(false);
  const [toast, setToast] = useState('');
  const [genericProductId, setGenericProductId] = useState(null);
  const [genericProducts, setGenericProducts] = useState([]);

  function showToast(msg) { setToast(msg); setTimeout(()=>setToast(''),2500); }

  useEffect(()=>{ loadProducts(); loadGenerics(); }, []);

  async function loadGenerics() {
    try {
      const res = await fetch(\`\${API}/products/generic\`);
      const data = await res.json();
      setGenericProducts(Array.isArray(data) ? data : []);
    } catch(e) {}
  }

  async function loadProducts() {
    setLoading(true);
    try {
      const res = await fetch(`${API}/products`);
      const data = await res.json();
      setProducts(Array.isArray(data) ? data : []);
    } catch(e) {}
    finally { setLoading(false); }
  }

  async function saveEdit() {
    setSaving(true);
    try {
      // Aktualizuj status i is_ready_to_eat
      await fetch(`${API}/products/${editProduct.id}/quick-update`, {
        method:'PATCH', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ status: editProduct.status, is_ready_to_eat: editProduct.is_ready_to_eat, generic_product_id: genericProductId||null })
      });
      // Aktualizuj sklepy przez PUT
      const existing = products.find(p=>p.id===editProduct.id);
      await fetch(`${API}/products/${editProduct.id}`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ ...existing, store_ids: editProduct.store_ids })
      });
      await loadProducts();
      setEditProduct(null);
      showToast('‚úì Zapisano');
    } catch(e) { showToast('B≈ÇƒÖd zapisu'); }
    finally { setSaving(false); }
  }

  const filtered = products
    .filter(p => {
      if (p.is_generic) return false; // ukryj generyczne
      if (search && !p.name.toLowerCase().includes(search.toLowerCase()) && !(p.brand||'').toLowerCase().includes(search.toLowerCase())) return false;
      if (filterStatus !== 'all' && p.status !== filterStatus) return false;
      if (filterStore !== 'all' && !(p.store_ids||[]).includes(Number(filterStore))) return false;
      return true;
    })
    .sort((a, b) => {
      if (sortBy === 'date_desc') return (b.id||0) - (a.id||0);
      if (sortBy === 'date_asc')  return (a.id||0) - (b.id||0);
      if (sortBy === 'name_asc')  return a.name.localeCompare(b.name, 'pl');
      if (sortBy === 'name_desc') return b.name.localeCompare(a.name, 'pl');
      return 0;
    });

  if (editProduct) {
    const storeList = stores.filter(s=>s.status!=='deleted');
    return (
      <div style={{minHeight:'100vh',background:'var(--bg)'}}>
        <Toast msg={toast}/>
        <Header icon='‚úèÔ∏è' sub='Edytuj produkt' onBack={()=>setEditProduct(null)} onHome={onHome}/>
        <div className="screen">
          <div style={{fontFamily:'Syne',fontSize:18,fontWeight:700,marginBottom:4}}>{editProduct.name}</div>
          {editProduct.brand&&<div style={{fontSize:12,color:'var(--muted)',marginBottom:16}}>{editProduct.brand}</div>}

          <div className="section-label">Sklepy</div>
          <div className="store-grid" style={{marginBottom:24}}>
            {storeList.map(s=>(
              <button key={s.id} className={`store-btn ${(editProduct.store_ids||[]).includes(s.id)?'active':''}`}
                onClick={()=>setEditProduct(prev=>({...prev, store_ids: (prev.store_ids||[]).includes(s.id) ? prev.store_ids.filter(x=>x!==s.id) : [...(prev.store_ids||[]),s.id]}))}>
                {(editProduct.store_ids||[]).includes(s.id)?'‚úì ':''}{s.name}
              </button>
            ))}
          </div>

          <div className="section-label">Gotowy do spo≈ºycia?</div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:24}}>
            {[{v:1,l:'‚úÖ Tak'},{v:0,l:'üç≥ Nie'},{v:null,l:'‚ùì Nie wiem'}].map(opt=>(
              <button key={String(opt.v)} onClick={()=>setEditProduct(prev=>({...prev,is_ready_to_eat:opt.v}))}
                style={{padding:'10px 6px',borderRadius:12,border:'none',cursor:'pointer',
                  background:editProduct.is_ready_to_eat===opt.v?'rgba(34,211,238,0.12)':'var(--surface)',
                  outline:editProduct.is_ready_to_eat===opt.v?'2px solid var(--accent)':'1px solid var(--border)',
                  color:editProduct.is_ready_to_eat===opt.v?'var(--accent)':'var(--muted)',textAlign:'center'}}>
                <div style={{fontSize:13,fontWeight:600}}>{opt.l}</div>
              </button>
            ))}
          </div>

          <div className="section-label">Produkt generyczny (opcjonalnie)</div>
        <select className="ingredient-unit" style={{width:'100%',padding:'11px 12px',borderRadius:12,marginBottom:20,fontSize:13}}
          value={genericProductId||''} onChange={e=>setGenericProductId(e.target.value?Number(e.target.value):null)}>
          <option value=''>‚Äî brak powiƒÖzania ‚Äî</option>
          {genericProducts.map(g=>(
            <option key={g.id} value={g.id}>{g.name} ({g.category})</option>
          ))}
        </select>
        {genericProductId && (
          <div style={{fontSize:11,color:'var(--muted)',marginTop:-14,marginBottom:16,paddingLeft:4}}>
            ‚ö† Ten produkt nie bƒôdzie brany do generowania jad≈Çospisu ‚Äî zamiast niego u≈ºywany jest szablon generyczny
          </div>
        )}

        <div className="section-label">Status</div>
          <div style={{display:'flex',flexDirection:'column',gap:8,marginBottom:28}}>
            {[
              {v:'active',l:'üü¢ Aktywny'},
              {v:'inactive_incomplete',l:'üî¥ Nieaktywny ‚Äî niekompletny'},
              {v:'inactive_deleted',l:'‚ö´ Nieaktywny ‚Äî usuniƒôty'},
            ].map(opt=>(
              <button key={opt.v} onClick={()=>setEditProduct(prev=>({...prev,status:opt.v}))}
                style={{padding:'12px',borderRadius:12,border:'none',cursor:'pointer',textAlign:'left',
                  background:editProduct.status===opt.v?'rgba(34,211,238,0.08)':'var(--surface)',
                  outline:editProduct.status===opt.v?'2px solid var(--accent)':'1px solid var(--border)',
                  color:editProduct.status===opt.v?'var(--text)':'var(--muted)',fontSize:14,fontWeight:editProduct.status===opt.v?600:400}}>
                {opt.l}
              </button>
            ))}
          </div>

          <button className="btn-primary" onClick={saveEdit} disabled={saving}>{saving?'Zapisujƒô...':'üíæ Zapisz zmiany'}</button>
          <button className="btn-secondary" onClick={()=>setEditProduct(null)}>Anuluj</button>
        </div>
      </div>
    );
  }

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Toast msg={toast}/>
      <Header icon='üóÑ' sub={`Produkty (${filtered.length})`} onBack={onBack} onHome={onHome}/>
      <div className="screen">
        <input className="search-input" placeholder="üîç Szukaj po nazwie lub marce..." value={search} onChange={e=>setSearch(e.target.value)}/>

        <div className="filter-bar" style={{marginBottom:8}}>
          <span style={{fontSize:10,color:'var(--muted)',fontFamily:'DM Mono,monospace',letterSpacing:1,alignSelf:'center',flexShrink:0}}>SORTUJ:</span>
          {[
            ['date_desc','‚Üì Najnowsze'],
            ['date_asc', '‚Üë Najstarsze'],
            ['name_asc', 'A‚ÜíZ'],
            ['name_desc','Z‚ÜíA'],
          ].map(([v,l])=>(
            <button key={v} className={`filter-chip ${sortBy===v?'active':''}`} onClick={()=>setSortBy(v)}>{l}</button>
          ))}
        </div>

        <div className="filter-bar">
          {[['all','Wszystkie'],['active','Aktywne'],['inactive_incomplete','Niekompletne'],['inactive_deleted','Usuniƒôte']].map(([v,l])=>(
            <button key={v} className={`filter-chip ${filterStatus===v?'active':''}`} onClick={()=>setFilterStatus(v)}>{l}</button>
          ))}
        </div>

        <div className="filter-bar">
          <button className={`filter-chip ${filterStore==='all'?'active':''}`} onClick={()=>setFilterStore('all')}>Wszystkie sklepy</button>
          {stores.map(s=>(
            <button key={s.id} className={`filter-chip ${filterStore===String(s.id)?'active':''}`}
              onClick={()=>setFilterStore(String(s.id))}>{s.name}</button>
          ))}
        </div>

        {loading ? <Dots/> : filtered.length === 0 ? (
          <div style={{textAlign:'center',padding:'40px 0',color:'var(--muted)',fontSize:14}}>Brak wynik√≥w</div>
        ) : (
          filtered.map(p=>(
            <div key={p.id} className="product-row" onClick={()=>{
                const sids = Array.isArray(p.store_ids) ? p.store_ids : (p.store_ids ? p.store_ids.toString().split(',').map(Number) : []);
                setEditProduct({...p, store_ids: sids});
                setGenericProductId(p.generic_product_id||null);
              }}>
              {p.image_url ? <img className="product-row-img" src={p.image_url} alt={p.name} style={{width:44,height:44,borderRadius:10,objectFit:'contain',background:'var(--surface2)'}}/>
                : <div className="product-row-img">ü•´</div>}
              <div className="product-row-info">
                <div className="product-row-name">{p.name}</div>
                <div className="product-row-meta">
                  {p.brand&&<>{p.brand} ¬∑ </>}
                  {p.calories_per_100g&&<>{Math.round(p.calories_per_100g)} kcal ¬∑ </>}
                  {p.category||'inne'}
                  {p.created_at&&<> ¬∑ {new Date(p.created_at).toLocaleDateString('pl-PL')}</>}
                </div>
                {(() => {
                  const sids = Array.isArray(p.store_ids) ? p.store_ids : (p.store_ids ? p.store_ids.toString().split(',').map(Number) : []);
                  const names = sids.map(id => stores.find(s=>s.id===id)?.name).filter(Boolean);
                  return names.length > 0
                    ? <div style={{fontSize:10,color:'var(--accent)',marginTop:2,opacity:0.7}}>{names.join(' ¬∑ ')}</div>
                    : null;
                })()}
              </div>
              <StatusBadge status={p.status}/>
            </div>
          ))
        )}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ StoresScreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function StoresScreen({ stores, reloadStores, onBack, onHome }) {
  const [name, setName] = useState('');
  const [saving, setSaving] = useState(false);
  const [toast, setToast] = useState('');

  function showToast(msg) { setToast(msg); setTimeout(()=>setToast(''),2000); }

  async function addStore() {
    if (!name.trim()) return;
    setSaving(true);
    try {
      await fetch(`${API}/stores`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name:name.trim()}) });
      setName(''); reloadStores(); showToast('‚úì Sklep dodany');
    } catch(e) { showToast('B≈ÇƒÖd'); }
    finally { setSaving(false); }
  }

  async function toggleStatus(store) {
    const next = store.status === 'active' ? 'inactive' : store.status === 'inactive' ? 'deleted' : 'active';
    await fetch(`${API}/stores/${store.id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status:next}) });
    reloadStores();
  }

  const statusLabel = { active:'üü¢ Aktywny', inactive:'üî¥ Nieaktywny', deleted:'‚ö´ Usuniƒôty' };
  const nextLabel = { active:'‚Üí Dezaktywuj', inactive:'‚Üí Usu≈Ñ', deleted:'‚Üí Aktywuj' };

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Toast msg={toast}/>
      <Header icon='üè™' sub='Sklepy' onBack={onBack} onHome={onHome}/>
      <div className="screen">
        <div className="section-label">Dodaj nowy sklep</div>
        <div className="manual-input-wrap" style={{marginBottom:24}}>
          <input className="manual-input" placeholder="Nazwa sklepu..." value={name}
            onChange={e=>setName(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addStore()}/>
          <button className="manual-btn" onClick={addStore} disabled={saving||!name.trim()}>+</button>
        </div>

        <div className="section-label">Wszystkie sklepy</div>
        {stores.map(s=>(
          <div key={s.id} className="store-row">
            <div>
              <div className="store-row-name">{s.name}</div>
              <div style={{fontSize:12,color:'var(--muted)',marginTop:3}}>{statusLabel[s.status]||s.status}</div>
            </div>
            <button className="add-btn-sm" onClick={()=>toggleStatus(s)}>{nextLabel[s.status]}</button>
          </div>
        ))}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ Main Menu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


// ‚îÄ‚îÄ MealPlannerScreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const MEAL_TYPES = ['breakfast','lunch','dinner','snack'];
const MEAL_TYPE_LABELS = { breakfast:'≈öniadanie', lunch:'Obiad', dinner:'Kolacja', snack:'PrzekƒÖska' };
const UNITS = ['g','ml','piece','tbsp','tsp','cup'];
const UNIT_LABELS = { g:'g', ml:'ml', piece:'szt', tbsp:'≈Çy≈ºka', tsp:'≈Çy≈ºeczka', cup:'szklanka' };

function gramsForUnit(unit, qty, servingWeightG) {
  if (unit === 'piece') return qty * (servingWeightG || 100);
  if (unit === 'tbsp')  return qty * 14;
  if (unit === 'tsp')   return qty * 5;
  if (unit === 'cup')   return qty * 240;
  return qty; // g or ml
}

function calcNutrient(product, field, grams) {
  const per100 = product[field] || 0;
  return (grams / 100) * per100;
}

function fmtVal(val, decimals = 1) {
  if (val == null || isNaN(val)) return '‚Äî';
  return val < 0.01 ? '0' : val.toFixed(decimals);
}

function fmtUnit(field) {
  // witaminy i minera≈Çy mogƒÖ byƒá w ¬µg lub mg
  if (['vitamin_a','vitamin_b9','vitamin_b12','vitamin_d','vitamin_k','selenium','iodine','chromium'].some(x=>field.includes(x))) return '¬µg';
  if (field.includes('vitamin') || field.includes('calcium') || field.includes('iron') || field.includes('magnesium') || field.includes('phosphorus') || field.includes('potassium') || field.includes('zinc') || field.includes('copper') || field.includes('manganese') || field.includes('sodium')) return 'mg';
  return 'g';
}

// Referencyjne dzienne warto≈õci (dla paska)
const DRI = {
  calories_per_100g: 2000, protein_per_100g: 50, carbs_per_100g: 275, fat_per_100g: 78,
  fiber_per_100g: 28, sugars_per_100g: 50, saturated_fat_per_100g: 20, salt_per_100g: 6,
  vitamin_a_per_100g: 900, vitamin_b1_per_100g: 1.2, vitamin_b2_per_100g: 1.3,
  vitamin_b3_per_100g: 16, vitamin_b6_per_100g: 1.7, vitamin_b9_per_100g: 400,
  vitamin_b12_per_100g: 2.4, vitamin_c_per_100g: 90, vitamin_d_per_100g: 20,
  vitamin_e_per_100g: 15, vitamin_k_per_100g: 120,
  calcium_per_100g: 1000, iron_per_100g: 18, magnesium_per_100g: 420,
  phosphorus_per_100g: 700, potassium_per_100g: 3500, zinc_per_100g: 11,
  selenium_per_100g: 55, copper_per_100g: 0.9, manganese_per_100g: 2.3,
  iodine_per_100g: 150, sodium_per_100g: 2300,
};

function MealPlannerScreen({ stores, onBack, onHome }) {
  const [allProducts, setAllProducts] = useState([]);
  const [loadingProducts, setLoadingProducts] = useState(true);
  const [mealName, setMealName] = useState('');
  const [mealType, setMealType] = useState('lunch');
  const [ingredients, setIngredients] = useState([
    { id: Date.now(), product_id: '', qty: 100, unit: 'g' }
  ]);
  const [saving, setSaving] = useState(false);
  const [toast, setToast] = useState('');

  function showToast(msg) { setToast(msg); setTimeout(()=>setToast(''), 2500); }

  useEffect(()=>{
    fetch(`${API}/products`)
      .then(r=>r.json())
      .then(data => {
        setAllProducts(data.filter(p => p.status === 'active' && p.calories_per_100g));
        setLoadingProducts(false);
      })
      .catch(()=>setLoadingProducts(false));
  }, []);

  function addIngredient() {
    setIngredients(prev=>[...prev, { id: Date.now(), product_id:'', qty:100, unit:'g' }]);
  }

  function removeIngredient(id) {
    setIngredients(prev=>prev.filter(i=>i.id!==id));
  }

  function updateIngredient(id, field, value) {
    setIngredients(prev=>prev.map(i=>i.id===id ? {...i, [field]:value} : i));
  }

  // Oblicz sumy od≈ºywcze dla wszystkich sk≈Çadnik√≥w
  const nutrition = React.useMemo(() => {
    const totals = {};
    const FIELDS = [
      'calories_per_100g','protein_per_100g','carbs_per_100g','fat_per_100g',
      'fiber_per_100g','sugars_per_100g','saturated_fat_per_100g','salt_per_100g','sodium_per_100g',
      'vitamin_a_per_100g','vitamin_b1_per_100g','vitamin_b2_per_100g','vitamin_b3_per_100g',
      'vitamin_b6_per_100g','vitamin_b9_per_100g','vitamin_b12_per_100g','vitamin_c_per_100g',
      'vitamin_d_per_100g','vitamin_e_per_100g','vitamin_k_per_100g',
      'calcium_per_100g','iron_per_100g','magnesium_per_100g','phosphorus_per_100g',
      'potassium_per_100g','zinc_per_100g','selenium_per_100g','copper_per_100g',
      'manganese_per_100g','iodine_per_100g','sodium_per_100g',
    ];
    FIELDS.forEach(f => { totals[f] = 0; });

    ingredients.forEach(ing => {
      const product = allProducts.find(p=>p.id===Number(ing.product_id));
      if (!product) return;
      const grams = gramsForUnit(ing.unit, Number(ing.qty)||0, product.serving_weight_g);
      FIELDS.forEach(f => { totals[f] += calcNutrient(product, f, grams); });
    });

    return totals;
  }, [ingredients, allProducts]);

  // Flagi dietetyczne na podstawie sk≈Çadnik√≥w
  const dietaryFlags = React.useMemo(() => {
    const usedProducts = ingredients
      .map(i=>allProducts.find(p=>p.id===Number(i.product_id)))
      .filter(Boolean);
    if (!usedProducts.length) return {};
    return {
      vegan:      usedProducts.every(p=>p.is_vegan===1),
      vegetarian: usedProducts.every(p=>p.is_vegetarian===1||p.is_vegan===1),
      gluten_free:usedProducts.every(p=>p.is_gluten_free===1),
      lactose_free:usedProducts.every(p=>p.is_lactose_free===1),
      organic:    usedProducts.every(p=>p.is_organic===1),
    };
  }, [ingredients, allProducts]);

  async function saveMeal() {
    if (!mealName.trim()) return showToast('Podaj nazwƒô posi≈Çku');
    const valid = ingredients.filter(i=>i.product_id && Number(i.qty)>0);
    if (!valid.length) return showToast('Dodaj przynajmniej jeden sk≈Çadnik');
    setSaving(true);
    try {
      const body = {
        name: mealName.trim(),
        meal_type: mealType,
        ingredients: valid.map(i=>({
          product_id: Number(i.product_id),
          quantity: Number(i.qty),
          unit: i.unit,
        }))
      };
      const res = await fetch(`${API}/meals`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
      });
      if (!res.ok) throw new Error('B≈ÇƒÖd zapisu');
      showToast('‚úì Posi≈Çek zapisany!');
      setMealName(''); setIngredients([{id:Date.now(),product_id:'',qty:100,unit:'g'}]);
    } catch(e) { showToast('B≈ÇƒÖd: '+e.message); }
    finally { setSaving(false); }
  }

  const macroColors = { protein:'#22d3ee', carbs:'#a78bfa', fat:'#fbbf24' };
  const hasAnyNutrition = nutrition.calories_per_100g > 0;

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)',display:'flex',flexDirection:'column'}}>
      <Toast msg={toast}/>
      <Header icon='üçΩ' sub='Planer posi≈Çk√≥w' onBack={onBack} onHome={onHome}/>

      <div className="planner-layout">
        {/* ‚îÄ‚îÄ LEWA STRONA: formularz ‚îÄ‚îÄ */}
        <div className="planner-left">

          {/* Nazwa */}
          <div>
            <div className="planner-section-label">Nazwa posi≈Çku</div>
            <input className="planner-input" placeholder="np. Kurczak z ry≈ºem i warzywami..."
              value={mealName} onChange={e=>setMealName(e.target.value)}/>
          </div>

          {/* Typ */}
          <div>
            <div className="planner-section-label">Pora dnia</div>
            <div className="planner-meal-type">
              {MEAL_TYPES.map(t=>(
                <button key={t} className={`meal-type-btn ${mealType===t?'active':''}`}
                  onClick={()=>setMealType(t)}>
                  {MEAL_TYPE_LABELS[t]}
                </button>
              ))}
            </div>
          </div>

          {/* Sk≈Çadniki */}
          <div style={{flex:1}}>
            <div className="planner-section-label">Sk≈Çadniki</div>

            {/* Nag≈Ç√≥wek kolumn */}
            <div style={{display:'grid',gridTemplateColumns:'1fr 80px 90px 32px',gap:8,marginBottom:4}}>
              {['Produkt','Ilo≈õƒá','Jednostka',''].map((h,i)=>(
                <div key={i} style={{fontSize:10,color:'var(--muted)',fontFamily:'DM Mono,monospace',letterSpacing:1}}>{h}</div>
              ))}
            </div>

            {loadingProducts ? <Dots/> : ingredients.map((ing)=>{
              const product = allProducts.find(p=>p.id===Number(ing.product_id));
              const grams = product ? gramsForUnit(ing.unit, Number(ing.qty)||0, product.serving_weight_g) : 0;
              const kcal = product ? calcNutrient(product,'calories_per_100g',grams) : 0;
              return (
                <div key={ing.id}>
                  <div className="ingredient-row">
                    <select className="ingredient-select" value={ing.product_id}
                      onChange={e=>updateIngredient(ing.id,'product_id',e.target.value)}>
                      <option value=''>‚Äî wybierz produkt ‚Äî</option>
                      {allProducts.map(p=>(
                        <option key={p.id} value={p.id}>{p.name}{p.brand?` (${p.brand})`:''}</option>
                      ))}
                    </select>
                    <input className="ingredient-qty" type="number" min="0" value={ing.qty}
                      onChange={e=>updateIngredient(ing.id,'qty',e.target.value)}/>
                    <select className="ingredient-unit" value={ing.unit}
                      onChange={e=>updateIngredient(ing.id,'unit',e.target.value)}>
                      {UNITS.map(u=><option key={u} value={u}>{UNIT_LABELS[u]}</option>)}
                    </select>
                    <button className="remove-btn" onClick={()=>removeIngredient(ing.id)}>√ó</button>
                  </div>
                  {product && kcal > 0 && (
                    <div style={{fontSize:11,color:'var(--muted)',paddingLeft:4,paddingBottom:6,fontFamily:'DM Mono,monospace'}}>
                      {Math.round(kcal)} kcal ¬∑ {fmtVal(calcNutrient(product,'protein_per_100g',grams))}g B ¬∑ {fmtVal(calcNutrient(product,'carbs_per_100g',grams))}g W ¬∑ {fmtVal(calcNutrient(product,'fat_per_100g',grams))}g T
                      {grams !== (Number(ing.qty)||0) && <span style={{marginLeft:8,opacity:0.6}}>({Math.round(grams)}g)</span>}
                    </div>
                  )}
                </div>
              );
            })}

            <button className="add-ingredient-btn" onClick={addIngredient}>
              + Dodaj sk≈Çadnik
            </button>
          </div>

          <button className="save-meal-btn" onClick={saveMeal} disabled={saving||!mealName.trim()}>
            {saving ? 'Zapisujƒô...' : 'üíæ Zapisz posi≈Çek w NutriCart'}
          </button>
        </div>

        {/* ‚îÄ‚îÄ PRAWA STRONA: podsumowanie ‚îÄ‚îÄ */}
        <div className="planner-right">
          {!hasAnyNutrition ? (
            <div style={{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'100%',color:'var(--muted)',textAlign:'center',gap:16}}>
              <div style={{fontSize:64,opacity:0.3}}>ü•ó</div>
              <div style={{fontFamily:'DM Mono,monospace',fontSize:12,letterSpacing:2}}>DODAJ SK≈ÅADNIKI<br/>ABY ZOBACZYƒÜ WARTO≈öCI</div>
            </div>
          ) : (
            <>
              {/* Hero ‚Äî kalorie */}
              <div className="nutrition-hero">
                <div className="nutrition-hero-kcal">{Math.round(nutrition.calories_per_100g)}</div>
                <div className="nutrition-hero-label">KILOKALORII ≈ÅƒÑCZNIE</div>
                <div className="macro-row">
                  {[
                    {f:'protein_per_100g',   l:'BIA≈ÅKO',      c:'#22d3ee'},
                    {f:'carbs_per_100g',     l:'WƒòGLOWODANY', c:'#a78bfa'},
                    {f:'fat_per_100g',       l:'T≈ÅUSZCZE',    c:'#fbbf24'},
                  ].map(({f,l,c})=>(
                    <div key={f} className="macro-card">
                      <div className="macro-card-val" style={{color:c}}>{fmtVal(nutrition[f],1)}g</div>
                      <div className="macro-card-lbl">{l}</div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Flagi dietetyczne */}
              {Object.values(dietaryFlags).some(Boolean) && (
                <div className="dietary-flags" style={{marginBottom:16}}>
                  {Object.entries({
                    vegan:'üå± Wega≈Ñski', vegetarian:'ü•¨ Wegetaria≈Ñski',
                    gluten_free:'üåæ Bez glutenu', lactose_free:'ü•õ Bez laktozy',
                    organic:'‚ôª Bio'
                  }).map(([k,l])=>(
                    <span key={k} className={`dietary-flag ${dietaryFlags[k]?'yes':'no'}`}>{l}</span>
                  ))}
                </div>
              )}

              {/* Sk≈Çadniki ‚Äî lista */}
              <div className="micro-section" style={{marginBottom:16}}>
                <div className="micro-section-title">Sk≈Çadniki posi≈Çku</div>
                {ingredients.filter(i=>i.product_id).map(ing=>{
                  const p = allProducts.find(x=>x.id===Number(ing.product_id));
                  if (!p) return null;
                  const grams = gramsForUnit(ing.unit, Number(ing.qty)||0, p.serving_weight_g);
                  const kcal = calcNutrient(p,'calories_per_100g',grams);
                  return (
                    <div key={ing.id} className="ingr-summary-row">
                      <div>
                        <div style={{fontWeight:500,color:'var(--text)'}}>{p.name}</div>
                        <div style={{fontSize:11,color:'var(--muted)',marginTop:2}}>{Number(ing.qty)} {UNIT_LABELS[ing.unit]}{grams!==Number(ing.qty)?` ¬∑ ${Math.round(grams)}g`:''}</div>
                      </div>
                      <div style={{textAlign:'right',flexShrink:0}}>
                        <div style={{fontFamily:'DM Mono,monospace',fontSize:13,color:'var(--accent)'}}>{Math.round(kcal)} kcal</div>
                        <div style={{fontSize:11,color:'var(--muted)'}}>B:{fmtVal(calcNutrient(p,'protein_per_100g',grams))} W:{fmtVal(calcNutrient(p,'carbs_per_100g',grams))} T:{fmtVal(calcNutrient(p,'fat_per_100g',grams))}</div>
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Szczeg√≥≈Çowe makro */}
              <div className="micro-section" style={{marginBottom:16}}>
                <div className="micro-section-title">Makrosk≈Çadniki szczeg√≥≈Çowo</div>
                {[
                  {f:'fiber_per_100g',          l:'B≈Çonnik',             u:'g'},
                  {f:'sugars_per_100g',          l:'Cukry',               u:'g'},
                  {f:'saturated_fat_per_100g',   l:'T≈Çuszcze nasycone',   u:'g'},
                  {f:'salt_per_100g',            l:'S√≥l',                 u:'g'},
                  {f:'sodium_per_100g',          l:'S√≥d',                 u:'mg'},
                ].map(({f,l,u})=>{
                  const val = nutrition[f]||0;
                  const dri = DRI[f]||1;
                  const pct = Math.min(100, (val/dri)*100);
                  return (
                    <div key={f} className="micro-row">
                      <span className="micro-name">{l}</span>
                      <div style={{display:'flex',alignItems:'center',gap:8}}>
                        <span className="micro-val">{fmtVal(val,1)} {u}</span>
                        <div className="micro-bar-wrap"><div className="micro-bar" style={{width:`${pct}%`}}/></div>
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Witaminy */}
              <div className="micro-section" style={{marginBottom:16}}>
                <div className="micro-section-title">Witaminy</div>
                {[
                  {f:'vitamin_c_per_100g', l:'Witamina C',  u:'mg'},
                  {f:'vitamin_a_per_100g', l:'Witamina A',  u:'¬µg'},
                  {f:'vitamin_d_per_100g', l:'Witamina D',  u:'¬µg'},
                  {f:'vitamin_e_per_100g', l:'Witamina E',  u:'mg'},
                  {f:'vitamin_k_per_100g', l:'Witamina K',  u:'¬µg'},
                  {f:'vitamin_b1_per_100g',l:'B1 (Tiamina)',u:'mg'},
                  {f:'vitamin_b2_per_100g',l:'B2 (Rybofl.)',u:'mg'},
                  {f:'vitamin_b3_per_100g',l:'B3 (Niacyna)',u:'mg'},
                  {f:'vitamin_b6_per_100g',l:'B6',          u:'mg'},
                  {f:'vitamin_b9_per_100g',l:'B9 (Folian)', u:'¬µg'},
                  {f:'vitamin_b12_per_100g',l:'B12',        u:'¬µg'},
                ].filter(({f})=>(nutrition[f]||0)>0).map(({f,l,u})=>{
                  const val = nutrition[f]||0;
                  const dri = DRI[f]||1;
                  const pct = Math.min(100,(val/dri)*100);
                  return (
                    <div key={f} className="micro-row">
                      <span className="micro-name">{l}</span>
                      <div style={{display:'flex',alignItems:'center',gap:8}}>
                        <span className="micro-val">{fmtVal(val,2)} {u}</span>
                        <div className="micro-bar-wrap"><div className="micro-bar" style={{width:`${pct}%`}}/></div>
                      </div>
                    </div>
                  );
                })}
                {[
                  'vitamin_c_per_100g','vitamin_a_per_100g','vitamin_d_per_100g','vitamin_e_per_100g',
                  'vitamin_k_per_100g','vitamin_b1_per_100g','vitamin_b2_per_100g','vitamin_b3_per_100g',
                  'vitamin_b6_per_100g','vitamin_b9_per_100g','vitamin_b12_per_100g'
                ].every(f=>(nutrition[f]||0)===0) && (
                  <div className="micro-row" style={{color:'var(--muted)',fontSize:12,justifyContent:'center'}}>
                    brak danych o witaminach
                  </div>
                )}
              </div>

              {/* Minera≈Çy */}
              <div className="micro-section">
                <div className="micro-section-title">Minera≈Çy</div>
                {[
                  {f:'calcium_per_100g',   l:'Wap≈Ñ',     u:'mg'},
                  {f:'iron_per_100g',      l:'≈ªelazo',   u:'mg'},
                  {f:'magnesium_per_100g', l:'Magnez',   u:'mg'},
                  {f:'potassium_per_100g', l:'Potas',    u:'mg'},
                  {f:'phosphorus_per_100g',l:'Fosfor',   u:'mg'},
                  {f:'zinc_per_100g',      l:'Cynk',     u:'mg'},
                  {f:'selenium_per_100g',  l:'Selen',    u:'¬µg'},
                  {f:'copper_per_100g',    l:'Mied≈∫',    u:'mg'},
                  {f:'manganese_per_100g', l:'Mangan',   u:'mg'},
                  {f:'iodine_per_100g',    l:'Jod',      u:'¬µg'},
                ].filter(({f})=>(nutrition[f]||0)>0).map(({f,l,u})=>{
                  const val = nutrition[f]||0;
                  const dri = DRI[f]||1;
                  const pct = Math.min(100,(val/dri)*100);
                  return (
                    <div key={f} className="micro-row">
                      <span className="micro-name">{l}</span>
                      <div style={{display:'flex',alignItems:'center',gap:8}}>
                        <span className="micro-val">{fmtVal(val,1)} {u}</span>
                        <div className="micro-bar-wrap"><div className="micro-bar" style={{width:`${pct}%`}}/></div>
                      </div>
                    </div>
                  );
                })}
                {[
                  'calcium_per_100g','iron_per_100g','magnesium_per_100g','potassium_per_100g',
                  'phosphorus_per_100g','zinc_per_100g','selenium_per_100g','copper_per_100g',
                  'manganese_per_100g','iodine_per_100g'
                ].every(f=>(nutrition[f]||0)===0) && (
                  <div className="micro-row" style={{color:'var(--muted)',fontSize:12,justifyContent:'center'}}>
                    brak danych o minera≈Çach
                  </div>
                )}
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
}


// ‚îÄ‚îÄ GenericProductsScreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const CATEGORIES = ['owoce','warzywa','miƒôso','nabia≈Ç','zbo≈ºa','strƒÖczkowe','orzechy','napoje','s≈Çodycze','przekƒÖski','sosy','przyprawy','mro≈ºone','konserwy','inne'];

function GenericProductsScreen({ stores, onBack, onHome }) {
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);
  const [editItem, setEditItem] = useState(null); // null = nowy, object = edytowany
  const [toast, setToast] = useState('');
  const [search, setSearch] = useState('');
  const [saving, setSaving] = useState(false);

  // Formularz
  const emptyForm = { name:'', category:'inne', calories_per_100g:'', protein_per_100g:'', carbs_per_100g:'', fat_per_100g:'', fiber_per_100g:'', sugars_per_100g:'', saturated_fat_per_100g:'', salt_per_100g:'', serving_unit:'g', serving_weight_g:'100', is_ready_to_eat:null };
  const [form, setForm] = useState(emptyForm);

  function showToast(msg) { setToast(msg); setTimeout(()=>setToast(''),2500); }

  async function load() {
    setLoading(true);
    try {
      const res = await fetch(`${API}/products/generic`);
      const data = await res.json();
      setProducts(Array.isArray(data) ? data : []);
    } catch(e) {}
    finally { setLoading(false); }
  }

  useEffect(()=>{ load(); }, []);

  function openNew() {
    setForm(emptyForm);
    setEditItem(null);
    setShowForm(true);
  }

  function openEdit(p) {
    setForm({
      name: p.name||'', category: p.category||'inne',
      calories_per_100g: p.calories_per_100g||'',
      protein_per_100g: p.protein_per_100g||'',
      carbs_per_100g: p.carbs_per_100g||'',
      fat_per_100g: p.fat_per_100g||'',
      fiber_per_100g: p.fiber_per_100g||'',
      sugars_per_100g: p.sugars_per_100g||'',
      saturated_fat_per_100g: p.saturated_fat_per_100g||'',
      salt_per_100g: p.salt_per_100g||'',
      serving_unit: p.serving_unit||'g',
      serving_weight_g: p.serving_weight_g||100,
      is_ready_to_eat: p.is_ready_to_eat,
    });
    setEditItem(p);
    setShowForm(true);
  }

  function setF(k, v) { setForm(prev=>({...prev, [k]:v})); }

  async function save() {
    if (!form.name.trim()) return showToast('Podaj nazwƒô');
    setSaving(true);
    try {
      const body = {
        ...form,
        calories_per_100g: form.calories_per_100g !== '' ? Number(form.calories_per_100g) : null,
        protein_per_100g:  form.protein_per_100g  !== '' ? Number(form.protein_per_100g)  : null,
        carbs_per_100g:    form.carbs_per_100g    !== '' ? Number(form.carbs_per_100g)    : null,
        fat_per_100g:      form.fat_per_100g      !== '' ? Number(form.fat_per_100g)      : null,
        fiber_per_100g:    form.fiber_per_100g    !== '' ? Number(form.fiber_per_100g)    : null,
        sugars_per_100g:   form.sugars_per_100g   !== '' ? Number(form.sugars_per_100g)   : null,
        saturated_fat_per_100g: form.saturated_fat_per_100g !== '' ? Number(form.saturated_fat_per_100g) : null,
        salt_per_100g:     form.salt_per_100g     !== '' ? Number(form.salt_per_100g)     : null,
        serving_weight_g:  Number(form.serving_weight_g)||100,
      };
      if (editItem) {
        await fetch(`${API}/products/generic/${editItem.id}`, {
          method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
        });
        showToast('‚úì Zaktualizowano');
      } else {
        await fetch(`${API}/products/generic`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
        });
        showToast('‚úì Dodano produkt generyczny');
      }
      await load();
      setShowForm(false);
    } catch(e) { showToast('B≈ÇƒÖd: '+e.message); }
    finally { setSaving(false); }
  }

  const filtered = products.filter(p =>
    !search || p.name.toLowerCase().includes(search.toLowerCase()) || (p.category||'').includes(search.toLowerCase())
  );

  // ‚îÄ‚îÄ Formularz ‚îÄ‚îÄ
  if (showForm) return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Toast msg={toast}/>
      <Header icon='üß¨' sub={editItem?'Edytuj generyczny':'Nowy generyczny'} onBack={()=>setShowForm(false)} onHome={onHome}/>
      <div className="screen" style={{maxWidth:560,margin:'0 auto'}}>

        <div className="planner-section-label">Nazwa i kategoria</div>
        <input className="planner-input" style={{marginBottom:10}} placeholder="np. Jab≈Çko, Ry≈º bia≈Çy, MƒÖka pszenna..."
          value={form.name} onChange={e=>setF('name',e.target.value)}/>
        <select className="ingredient-unit" style={{width:'100%',padding:'11px 12px',borderRadius:12,marginBottom:20,fontSize:14}}
          value={form.category} onChange={e=>setF('category',e.target.value)}>
          {CATEGORIES.map(c=><option key={c} value={c}>{c}</option>)}
        </select>

        <div className="planner-section-label">Warto≈õci od≈ºywcze (na 100g)</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:20}}>
          {[
            {k:'calories_per_100g',   l:'Kalorie (kcal)'},
            {k:'protein_per_100g',    l:'Bia≈Çko (g)'},
            {k:'carbs_per_100g',      l:'Wƒôglowodany (g)'},
            {k:'fat_per_100g',        l:'T≈Çuszcze (g)'},
            {k:'fiber_per_100g',      l:'B≈Çonnik (g)'},
            {k:'sugars_per_100g',     l:'Cukry (g)'},
            {k:'saturated_fat_per_100g',l:'T. nasycone (g)'},
            {k:'salt_per_100g',       l:'S√≥l (g)'},
          ].map(({k,l})=>(
            <div key={k}>
              <div style={{fontSize:11,color:'var(--muted)',marginBottom:4,fontFamily:'DM Mono,monospace',letterSpacing:1}}>{l}</div>
              <input className="ingredient-qty" style={{width:'100%',textAlign:'left',padding:'9px 12px'}}
                type="number" min="0" step="0.1" placeholder="‚Äî"
                value={form[k]} onChange={e=>setF(k,e.target.value)}/>
            </div>
          ))}
        </div>

        <div className="planner-section-label">Domy≈õlna porcja</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:10,marginBottom:20}}>
          <div>
            <div style={{fontSize:11,color:'var(--muted)',marginBottom:4,fontFamily:'DM Mono,monospace',letterSpacing:1}}>Jednostka</div>
            <select className="ingredient-unit" style={{width:'100%',padding:'11px 12px',borderRadius:12,fontSize:13}}
              value={form.serving_unit} onChange={e=>setF('serving_unit',e.target.value)}>
              {['g','ml','piece','tbsp','tsp','cup'].map(u=><option key={u} value={u}>{u}</option>)}
            </select>
          </div>
          <div>
            <div style={{fontSize:11,color:'var(--muted)',marginBottom:4,fontFamily:'DM Mono,monospace',letterSpacing:1}}>Waga porcji (g)</div>
            <input className="ingredient-qty" style={{width:'100%',textAlign:'left',padding:'9px 12px'}}
              type="number" min="1" value={form.serving_weight_g} onChange={e=>setF('serving_weight_g',e.target.value)}/>
          </div>
        </div>

        <div className="planner-section-label">Gotowy do spo≈ºycia?</div>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:8,marginBottom:28}}>
          {[{v:1,l:'‚úÖ Tak'},{v:0,l:'üç≥ Nie'},{v:null,l:'‚ùì Nie wiem'}].map(opt=>(
            <button key={String(opt.v)} onClick={()=>setF('is_ready_to_eat',opt.v)}
              style={{padding:'10px 6px',borderRadius:12,border:'none',cursor:'pointer',textAlign:'center',
                background:form.is_ready_to_eat===opt.v?'rgba(34,211,238,0.12)':'var(--surface)',
                outline:form.is_ready_to_eat===opt.v?'2px solid var(--accent)':'1px solid var(--border)',
                color:form.is_ready_to_eat===opt.v?'var(--accent)':'var(--muted)'}}>
              <div style={{fontSize:13,fontWeight:600}}>{opt.l}</div>
            </button>
          ))}
        </div>

        <button className="save-meal-btn" onClick={save} disabled={saving||!form.name.trim()}>
          {saving?'Zapisujƒô...':(editItem?'üíæ Zapisz zmiany':'üß¨ Dodaj produkt generyczny')}
        </button>
        <button className="btn-secondary" onClick={()=>setShowForm(false)}>Anuluj</button>
      </div>
    </div>
  );

  // ‚îÄ‚îÄ Lista ‚îÄ‚îÄ
  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Toast msg={toast}/>
      <Header icon='üß¨' sub={`Generyczne (${products.length})`} onBack={onBack} onHome={onHome}/>
      <div className="screen">
        <button className="btn-primary" onClick={openNew}>+ Dodaj produkt generyczny</button>
        <input className="search-input" placeholder="üîç Szukaj..." value={search} onChange={e=>setSearch(e.target.value)}/>

        {loading ? <Dots/> : filtered.length===0 ? (
          <div style={{textAlign:'center',padding:'40px 0',color:'var(--muted)'}}>
            <div style={{fontSize:48,marginBottom:12}}>üß¨</div>
            <div style={{fontSize:14}}>Brak produkt√≥w generycznych.<br/>Dodaj szablon np. "Jab≈Çko" czy "Ry≈º bia≈Çy".</div>
          </div>
        ) : filtered.map(p=>(
          <div key={p.id} className="product-row" onClick={()=>openEdit(p)}>
            <div className="product-row-img" style={{background:'var(--surface2)',fontSize:20}}>üß¨</div>
            <div className="product-row-info">
              <div className="product-row-name">{p.name}</div>
              <div className="product-row-meta">
                {p.category} ¬∑ {p.calories_per_100g ? `${Math.round(p.calories_per_100g)} kcal` : 'brak kalorii'}
                {p.is_ready_to_eat===1?' ¬∑ gotowy':p.is_ready_to_eat===0?' ¬∑ wymaga prep.':''}
              </div>
            </div>
            <div style={{display:'flex',flexDirection:'column',gap:4,alignItems:'flex-end',flexShrink:0}}>
              <span className="status-badge active">generyczny</span>
              <span style={{fontSize:10,color:'var(--muted)',fontFamily:'DM Mono,monospace'}}>
                B:{p.protein_per_100g!=null?Number(p.protein_per_100g).toFixed(1):'?'} W:{p.carbs_per_100g!=null?Number(p.carbs_per_100g).toFixed(1):'?'} T:{p.fat_per_100g!=null?Number(p.fat_per_100g).toFixed(1):'?'}
              </span>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

const MENU = [
  { id:'single',  icon:'üì∑', title:'Skanowanie produktu',    sub:'Skanuj i od razu konfiguruj' },
  { id:'bulk',    icon:'üì¶', title:'Skanowanie wielu',        sub:'Zapisuj kody na p√≥≈∫niej' },
  { id:'products',icon:'üóÑ', title:'Produkty',               sub:'PrzeglƒÖdaj i modyfikuj' },
  { id:'saved',   icon:'üóÇ', title:'Zapisane kody',           sub:'Z poprzednich sesji' },
  { id:'stores',  icon:'üè™', title:'Sklepy',                  sub:'ZarzƒÖdzaj sklepami' },
  { id:'planner', icon:'üçΩ', title:'Planer posi≈Çk√≥w',          sub:'Komponuj i zapisuj przepisy' },
  { id:'generics', icon:'üß¨', title:'Produkty generyczne',       sub:'Szablony bez barkod√≥w' },
];

function App() {
  const [screen, setScreen] = useState('menu');
  const [stores, reloadStores] = useStores();

  const onHome = () => setScreen('menu');
  const screenProps = { stores, onBack:onHome, onHome };

  if (screen === 'single')   return <SingleScanScreen {...screenProps}/>;
  if (screen === 'bulk')     return <BulkScanScreen {...screenProps}/>;
  if (screen === 'products') return <ProductsScreen {...screenProps}/>;
  if (screen === 'saved')    return <SavedBarcodesScreen {...screenProps}/>;
  if (screen === 'stores')   return <StoresScreen {...screenProps} reloadStores={reloadStores}/>;
  if (screen === 'planner')  return <MealPlannerScreen {...screenProps}/>;
  if (screen === 'generics') return <GenericProductsScreen {...screenProps}/>;

  return (
    <div style={{minHeight:'100vh',background:'var(--bg)'}}>
      <Header icon='üì°' sub='Product Scanner'/>
      <div className="menu-grid">
        {MENU.map(m=>(
          <button key={m.id} className="menu-card" onClick={()=>setScreen(m.id)}>
            <div className="menu-card-icon">{m.icon}</div>
            <div className="menu-card-title">{m.title}</div>
            <div className="menu-card-sub">{m.sub}</div>
          </button>
        ))}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
